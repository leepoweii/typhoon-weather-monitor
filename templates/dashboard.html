{% extends "base.html" %}

{% block content %}
<h1>🌀 颱風警訊播報系統</h1>
<p class="update-time">最後更新: <span id="updateTime">載入中...</span></p>

<!-- 警告狀態區塊 -->
<section class="warning-status-section">
    <h2>⚠️ 警告狀態</h2>
    
    <div class="risk-cards">
        <div class="risk-card flight-risk">
            <h3>✈️ 7/6 金門 → 台南航班</h3>
            <div class="risk-info">
                <div class="risk-level">
                    <span class="risk-label">風險等級：</span>
                    <span id="flightRiskLevel" class="risk-value">載入中...</span>
                </div>
                <div class="risk-reason">
                    <span class="reason-label">原因：</span>
                    <span id="flightRiskReason" class="reason-value">載入中...</span>
                </div>
            </div>
        </div>
        
        <div class="risk-card checkup-risk">
            <h3>🏥 7/7 台南體檢</h3>
            <div class="risk-info">
                <div class="risk-level">
                    <span class="risk-label">風險等級：</span>
                    <span id="checkupRiskLevel" class="risk-value">載入中...</span>
                </div>
                <div class="risk-reason">
                    <span class="reason-label">原因：</span>
                    <span id="checkupRiskReason" class="reason-value">載入中...</span>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- 目前警報區塊 -->
<section class="current-alerts-section">
    <h2>📢 目前警報</h2>
    <div id="currentAlerts" class="alerts-container">載入中...</div>
</section>

<!-- 中央氣象署颱風觀測地圖 -->
<section class="typhoon-map-section">
    <h2>🗺️ 中央氣象署颱風觀測地圖</h2>
    <div class="map-controls">
        <button onclick="toggleMap()" class="map-toggle-btn" id="mapToggleBtn">🗺️ 顯示地圖</button>
        <button onclick="refreshMap()" class="map-refresh-btn">🔄 刷新地圖</button>
        <a href="https://app.cwa.gov.tw/web/obsmap/typhoon.html" target="_blank" class="map-external-btn">🔗 在新視窗開啟</a>
    </div>
    <div class="map-container" id="mapContainer" style="display: none;">
        <iframe id="typhoonMap" 
                src="https://app.cwa.gov.tw/web/obsmap/typhoon.html"
                width="100%" 
                height="600" 
                frameborder="0"
                scrolling="auto"
                loading="lazy"
                title="中央氣象署颱風觀測地圖">
            <p>您的瀏覽器不支援 iframe。請 <a href="https://app.cwa.gov.tw/web/obsmap/typhoon.html" target="_blank">點擊這裡</a> 在新視窗開啟颱風觀測地圖。</p>
        </iframe>
    </div>
</section>

<hr class="section-divider">

<!-- 原始氣象資料區塊 -->
<section class="raw-data-section">
    <h2>📊 原始資料</h2>
    <div class="data-controls">
        <button onclick="refreshRawData()" class="refresh-btn">🔄 刷新資料</button>
        <button onclick="expandAll()" class="expand-btn">📖 展開全部</button>
        <button onclick="collapseAll()" class="collapse-btn">📘 收起全部</button>
    </div>

    <!-- 天氣特報資料 -->
    <div class="raw-data-block alert-block">
        <button class="collapsible" onclick="toggleContent('alert-content')">
            <span>⚠️</span> 天氣特報
            <span class="data-status" id="alert-status">載入中...</span>
            <span class="toggle-icon" id="alert-toggle">▶</span>
        </button>
        <div class="content" id="alert-content">
            <div id="alertData" class="alert-data">載入中...</div>
        </div>
    </div>

    <!-- 天氣預報資料 -->
    <div class="raw-data-block weather-block">
        <button class="collapsible" onclick="toggleContent('weather-content')">
            <span>🌤️</span> 天氣預報資料
            <span class="data-status" id="weather-status">載入中...</span>
            <span class="toggle-icon" id="weather-toggle">▶</span>
        </button>
        <div class="content" id="weather-content">
            <div class="weather-locations">
                <h4>📍 台南 7/5 - 7/10 詳細天氣預報</h4>
                <div id="tainanWeatherData" class="location-weather-data">載入中...</div>
                
                <h4>📍 金門 7/5 - 7/10 詳細天氣預報</h4>
                <div id="kinmenWeatherData" class="location-weather-data">載入中...</div>
            </div>
        </div>
    </div>

    <!-- 颱風詳細資料 -->
    <div class="raw-data-block typhoon-block">
        <button class="collapsible" onclick="toggleContent('typhoon-content')">
            <span>🌀</span> 颱風詳細資料
            <span class="data-status" id="typhoon-status">載入中...</span>
            <span class="toggle-icon" id="typhoon-toggle">▶</span>
        </button>
        <div class="content" id="typhoon-content">
            <div id="typhoonData" class="typhoon-data">載入中...</div>
        </div>
    </div>
</section>

<hr class="section-divider">

<!-- 分析依據區塊 -->
<section class="analysis-criteria-section">
    <h2>📋 分析依據</h2>
<!-- 分析依據區塊 -->
<section class="analysis-criteria-section">
    <h2>📋 分析依據</h2>
    
    <!-- 航班風險評估依據 -->
    <div class="criteria-block flight-criteria">
        <h3>✈️ 航班風險評估依據</h3>
        
        <div class="criteria-content">
            <h4>🛬 機型側風限制標準</h4>
            <ul>
                <li><strong>A321 (Airbus A321)</strong>：最大側風限制 <span class="risk-high">38節 (70km/h)</span></li>
                <li><strong>AT7 (ATR 72)</strong>：最大側風限制 <span class="risk-high">35節 (65km/h)</span></li>
            </ul>
            
            <h4>🌪️ 航班風險等級判定</h4>
            <ul>
                <li><strong>高風險</strong>：側風 > 35節 或 颱風風速 > 80km/h 或 暴風圈影響金門機場</li>
                <li><strong>中風險</strong>：側風 25-35節 或 颱風風速 60-80km/h 或 強風特報</li>
                <li><strong>低風險</strong>：側風 < 25節 且 無颱風威脅</li>
            </ul>
            
            <h4>🌧️ 天氣因子影響</h4>
            <ul>
                <li><strong>豪雨/大雨特報</strong>：能見度降低，影響起降安全</li>
                <li><strong>雷雨胞活動</strong>：可能造成航班延誤或改降</li>
                <li><strong>濃霧</strong>：嚴重影響機場作業</li>
            </ul>
            
            <p class="safety-note">
                <strong>⚠️ 航班安全提醒：</strong>超過側風限制時，機師可選擇重飛或改降其他機場。
                航空公司亦可能基於安全考量，主動調整起降標準或取消航班。
            </p>
        </div>
    </div>
    
    <!-- 體檢風險評估依據 -->
    <div class="criteria-block checkup-criteria">
        <h3>🏥 體檢風險評估依據</h3>
        
        <div class="criteria-content">
            <h4>🌀 颱風影響評估</h4>
            <ul>
                <li><strong>高風險</strong>：颱風風速 > 80km/h 或 暴風圈影響台南地區</li>
                <li><strong>中風險</strong>：颱風風速 60-80km/h 或 豪雨特報影響台南</li>
                <li><strong>低風險</strong>：颱風距離台南 > 600km 且風速 < 60km/h</li>
            </ul>
            
            <h4>🌧️ 天氣警報影響</h4>
            <ul>
                <li><strong>豪雨特報</strong>：可能造成交通中斷，影響體檢行程</li>
                <li><strong>強風特報</strong>：戶外活動風險增加</li>
                <li><strong>雷雨警報</strong>：建議避免外出或延後體檢</li>
            </ul>
            
            <h4>🚗 交通安全考量</h4>
            <ul>
                <li><strong>道路積水</strong>：豪雨可能造成市區道路積水</li>
                <li><strong>強風影響</strong>：側風可能影響駕駛安全</li>
                <li><strong>能見度</strong>：大雨或濃霧影響行車視線</li>
            </ul>
            
            <p class="safety-note">
                <strong>⚠️ 體檢安全提醒：</strong>遇惡劣天氣建議延後體檢行程，確保往返交通安全。
                可彈性調整體檢時間，以避開天氣高風險時段。
            </p>
        </div>
    </div>
</section>

<hr class="section-divider">

<!-- 資料來源與整理方法 -->
<section class="methodology-section">
    <h2>📋 資料來源與整理方法</h2>
    
    <div class="methodology-content">
        <h3>� 分析邏輯與方法說明</h3>
        <ul>
            <li><b>天氣特報</b>：直接採用中央氣象署API的警特報結果，若金門或台南有「颱風」或「強風」等現象，則列為警報。</li>
            <li><b>颱風路徑</b>：
                <ul>
                    <li>若颱風最大風速 <b>超過60 km/h</b>，則列為警報。</li>
                    <li>若颱風最大風速 <b>超過80 km/h</b>，則列為高風險警報。</li>
                    <li>使用地理位置過濾，只考慮會影響台灣金門地區的颱風 (距離600km內)。</li>
                    <li>結合風速強度和地理距離進行綜合評估。</li>
                </ul>
            </li>
            <li><b>天氣預報</b>：
                <ul>
                    <li>若36小時內預報有「颱風」、「暴風」、「豪雨」、「大雨」等關鍵字，則列為警報。</li>
                </ul>
            </li>
            <li><b>航班/體檢風險評估</b>：
                <ul>
                    <li>若有颱風警報，航班列為「高風險」；有強風則為「中風險」。</li>
                    <li>台南有颱風警報，體檢列為「高風險」；有強風或豪雨則為「中風險」。</li>
                    <li>體檢風險評估結合地理位置分析和基本風險評估。</li>
                </ul>
            </li>
        </ul>
        
        <div class="api-notice">
            <p><strong>📝 重要說明：</strong></p>
            <ul>
                <li>機場即時監控功能因 API 限制暫時禁用。航班風險評估基於天氣預報進行。</li>
                <li>所有分析規則可於程式碼內各分析方法查閱與調整。</li>
                <li>資料來源：中央氣象署開放資料平臺</li>
            </ul>
        </div>
    </div>
</section>

<hr class="section-divider">

<!-- API 資料統計 -->
<section class="api-stats-section">
    <h2>📊 API 資料統計</h2>
    <div class="raw-data-block api-stats-block">
        <button class="collapsible" onclick="toggleContent('api-stats-content')">
            <span>📊</span> API 統計資訊
            <span class="data-status" id="api-stats-status">載入中...</span>
            <span class="toggle-icon" id="api-stats-toggle">▶</span>
        </button>
        <div class="content" id="api-stats-content">
            <div id="apiStatsData" class="api-stats-data">載入中...</div>
        </div>
    </div>
</section>

<script>
    function toggleContent(contentId) {
        const content = document.getElementById(contentId);
        const toggleIcon = document.getElementById(contentId.replace('-content', '-toggle'));
        
        if (content.classList.contains('show')) {
            content.classList.remove('show');
            toggleIcon.classList.remove('rotated');
        } else {
            content.classList.add('show');
            toggleIcon.classList.add('rotated');
        }
    }

    function expandAll() {
        ['typhoon-content', 'alert-content', 'api-stats-content'].forEach(contentId => {
            const content = document.getElementById(contentId);
            const toggleIcon = document.getElementById(contentId.replace('-content', '-toggle'));
            if (content && toggleIcon) {
                content.classList.add('show');
                toggleIcon.classList.add('rotated');
            }
        });
    }

    function collapseAll() {
        ['typhoon-content', 'alert-content', 'api-stats-content'].forEach(contentId => {
            const content = document.getElementById(contentId);
            const toggleIcon = document.getElementById(contentId.replace('-content', '-toggle'));
            if (content && toggleIcon) {
                content.classList.remove('show');
                toggleIcon.classList.remove('rotated');
            }
        });
    }

    async function refreshRawData() {
        const refreshBtn = document.querySelector('.refresh-btn');
        refreshBtn.textContent = '⏳ 更新中...';
        refreshBtn.disabled = true;
        
        try {
            await updateRawData();
            refreshBtn.textContent = '✅ 已更新';
            setTimeout(() => {
                refreshBtn.textContent = '🔄 刷新資料';
                refreshBtn.disabled = false;
            }, 2000);
        } catch (error) {
            refreshBtn.textContent = '❌ 更新失敗';
            setTimeout(() => {
                refreshBtn.textContent = '🔄 刷新資料';
                refreshBtn.disabled = false;
            }, 2000);
        }
    }

    function formatRawData(data, type) {
        if (!data || Object.keys(data).length === 0) {
            return '<div class="no-data">📭 目前無資料</div>';
        }

        const timestamp = new Date().toLocaleString('zh-TW');
        let html = `<div class="data-timestamp">📅 資料時間: ${timestamp}</div>`;

        if (type === 'typhoon') {
            html += formatTyphoonData(data);
        } else if (type === 'weather') {
            html += formatWeatherData(data);
        } else if (type === 'alert') {
            html += formatAlertData(data);
        }
        
        return html || '<div class="no-data">❓ 無法解析資料</div>';
    }

    function formatTyphoonData(data) {
        let html = '';
        try {
            const records = data.records || {};
            
            if (records.tropicalCyclones && records.tropicalCyclones.tropicalCyclone) {
                const typhoons = records.tropicalCyclones.tropicalCyclone;
                
                html += `<div class="data-summary">🌀 發現 ${typhoons.length} 個熱帶氣旋</div>`;
                
                typhoons.forEach((typhoon, index) => {
                    const name = typhoon.cwaTyphoonName || typhoon.typhoonName || '未知熱帶氣旋';
                    const tyNo = typhoon.cwaTyNo || typhoon.cwaTdNo || '';
                    
                    // 颱風強度評級
                    let intensityClass = 'typhoon-weak';
                    let intensityText = '輕度';
                    const analysisData = typhoon.analysisData || {};
                    const fixes = analysisData.fix || [];
                    
                    if (fixes.length > 0) {
                        const latestFix = fixes[fixes.length - 1];
                        const windSpeed = parseInt(latestFix.maxWindSpeed || 0) * 3.6; // 轉換為 km/h
                        
                        if (windSpeed >= 118) {
                            intensityClass = 'typhoon-super';
                            intensityText = '強烈颱風';
                        } else if (windSpeed >= 88) {
                            intensityClass = 'typhoon-strong';
                            intensityText = '中度颱風';
                        } else if (windSpeed >= 62) {
                            intensityClass = 'typhoon-moderate';
                            intensityText = '輕度颱風';
                        } else if (windSpeed >= 34) {
                            intensityClass = 'typhoon-weak';
                            intensityText = '熱帶風暴';
                        } else {
                            intensityClass = 'typhoon-depression';
                            intensityText = '熱帶性低氣壓';
                        }
                    }
                    
                    html += `<div class="typhoon-card ${intensityClass}">`;
                    html += `<div class="typhoon-header">`;
                    html += `<h3 class="typhoon-name">� ${name}</h3>`;
                    html += `<span class="typhoon-intensity">${intensityText}</span>`;
                    html += `</div>`;
                    
                    html += `<div class="data-grid">`;
                    
                    if (tyNo) {
                        html += `<div class="data-item"><div class="data-item-label">🏷️ 編號</div><div class="data-item-value">${tyNo}</div></div>`;
                    }
                    
                    if (fixes.length > 0) {
                        const latestFix = fixes[fixes.length - 1];
                        
                        if (latestFix.maxWindSpeed) {
                            const windKmh = (parseInt(latestFix.maxWindSpeed) * 3.6).toFixed(1);
                            const windIcon = getWindIcon(windKmh);
                            html += `<div class="data-item wind-speed"><div class="data-item-label">${windIcon} 最大風速</div><div class="data-item-value">${latestFix.maxWindSpeed} m/s<br><small>(${windKmh} km/h)</small></div></div>`;
                        }
                        
                        if (latestFix.maxGustSpeed) {
                            const gustKmh = (parseInt(latestFix.maxGustSpeed) * 3.6).toFixed(1);
                            html += `<div class="data-item"><div class="data-item-label">💨 最大陣風</div><div class="data-item-value">${latestFix.maxGustSpeed} m/s<br><small>(${gustKmh} km/h)</small></div></div>`;
                        }
                        
                        if (latestFix.pressure) {
                            const pressureIcon = getPressureIcon(latestFix.pressure);
                            html += `<div class="data-item"><div class="data-item-label">${pressureIcon} 中心氣壓</div><div class="data-item-value">${latestFix.pressure} hPa</div></div>`;
                        }
                        
                        if (latestFix.movingSpeed) {
                            html += `<div class="data-item"><div class="data-item-label">🏃 移動速度</div><div class="data-item-value">${latestFix.movingSpeed} km/h</div></div>`;
                        }
                        
                        if (latestFix.movingDirection) {
                            const directionMap = {
                                'N': '北 ⬆️', 'NNE': '北北東 ↗️', 'NE': '東北 ↗️', 'ENE': '東北東 ↗️',
                                'E': '東 ➡️', 'ESE': '東南東 ↘️', 'SE': '東南 ↘️', 'SSE': '南南東 ↘️',
                                'S': '南 ⬇️', 'SSW': '南南西 ↙️', 'SW': '西南 ↙️', 'WSW': '西南西 ↙️',
                                'W': '西 ⬅️', 'WNW': '西北西 ↖️', 'NW': '西北 ↖️', 'NNW': '北北西 ↖️'
                            };
                            const directionZh = directionMap[latestFix.movingDirection] || latestFix.movingDirection;
                            html += `<div class="data-item"><div class="data-item-label">🧭 移動方向</div><div class="data-item-value">${directionZh}</div></div>`;
                        }
                        
                        if (latestFix.coordinate) {
                            try {
                                const [lon, lat] = latestFix.coordinate.split(',');
                                const distance = calculateDistanceToTaiwan(parseFloat(lat), parseFloat(lon));
                                html += `<div class="data-item"><div class="data-item-label">📍 座標位置</div><div class="data-item-value">${lat}°N, ${lon}°E<br><small>距台灣約 ${distance} km</small></div></div>`;
                            } catch (e) {
                                html += `<div class="data-item"><div class="data-item-label">📍 座標位置</div><div class="data-item-value">${latestFix.coordinate}</div></div>`;
                            }
                        }
                        
                        if (latestFix.circleOf15Ms && latestFix.circleOf15Ms.radius) {
                            html += `<div class="data-item storm-circle"><div class="data-item-label">🌪️ 暴風圈</div><div class="data-item-value">${latestFix.circleOf15Ms.radius} km 半徑</div></div>`;
                        }
                        
                        if (latestFix.fixTime) {
                            const timeAgo = getTimeAgo(latestFix.fixTime);
                            html += `<div class="data-item"><div class="data-item-label">🕐 觀測時間</div><div class="data-item-value">${latestFix.fixTime.substring(0, 16)}<br><small>${timeAgo}</small></div></div>`;
                        }
                    }
                    
                    html += `</div></div>`;
                    if (index < typhoons.length - 1) html += '<hr class="typhoon-separator">';
                });
            } else {
                html += '<div class="no-data">� 目前無活躍颱風</div>';
            }
        } catch (error) {
            console.error('解析颱風資料失敗:', error);
            html += '<div class="error-data">❌ 解析颱風資料失敗</div>';
        }
        
        return html;
    }

    function formatWeatherData(data) {
        let html = '';
        try {
            const records = data.records || {};
            const locations = records.location || [];
            
            if (locations.length === 0) {
                return '<div class="no-data">📭 無天氣預報資料</div>';
            }
            
            html += `<div class="data-summary">🌤️ 監控 ${locations.length} 個地區的天氣預報</div>`;
            
            locations.forEach((location, index) => {
                const locationName = location.locationName || '未知地區';
                const elements = location.weatherElement || [];
                
                html += `<div class="weather-card">`;
                html += `<h4 class="location-title">📍 ${locationName}</h4>`;
                html += `<div class="data-grid">`;
                
                // 整理資料結構，方便顯示
                const weatherInfo = {};
                elements.forEach(element => {
                    const elementName = element.elementName || '';
                    const times = element.time || [];
                    
                    if (times.length > 0) {
                        const latestTime = times[0];
                        const value = latestTime.parameter?.parameterName || '';
                        const startTime = latestTime.startTime || '';
                        
                        weatherInfo[elementName] = { value, startTime };
                    }
                });
                
                // 按優先順序顯示天氣資訊
                if (weatherInfo.Wx && weatherInfo.Wx.value) {
                    const weatherIcon = getWeatherIcon(weatherInfo.Wx.value);
                    html += `<div class="data-item weather-phenomenon"><div class="data-item-label">${weatherIcon} 天氣現象</div><div class="data-item-value">${weatherInfo.Wx.value}<br><small>${weatherInfo.Wx.startTime.substring(0, 16)}</small></div></div>`;
                }
                
                if (weatherInfo.PoP && weatherInfo.PoP.value) {
                    const rainIcon = getRainIcon(weatherInfo.PoP.value);
                    html += `<div class="data-item rain-probability"><div class="data-item-label">${rainIcon} 降雨機率</div><div class="data-item-value">${weatherInfo.PoP.value}%</div></div>`;
                }
                
                // 溫度範圍
                const minTemp = weatherInfo.MinT?.value;
                const maxTemp = weatherInfo.MaxT?.value;
                if (minTemp && maxTemp) {
                    const tempIcon = getTempIcon(maxTemp);
                    html += `<div class="data-item temperature-range"><div class="data-item-label">${tempIcon} 溫度範圍</div><div class="data-item-value">${minTemp}°C ~ ${maxTemp}°C</div></div>`;
                } else {
                    if (minTemp) {
                        html += `<div class="data-item"><div class="data-item-label">🌡️ 最低溫度</div><div class="data-item-value">${minTemp}°C</div></div>`;
                    }
                    if (maxTemp) {
                        html += `<div class="data-item"><div class="data-item-label">🌡️ 最高溫度</div><div class="data-item-value">${maxTemp}°C</div></div>`;
                    }
                }
                
                if (weatherInfo.CI && weatherInfo.CI.value) {
                    const comfortIcon = getComfortIcon(weatherInfo.CI.value);
                    html += `<div class="data-item comfort-index"><div class="data-item-label">${comfortIcon} 舒適度</div><div class="data-item-value">${weatherInfo.CI.value}</div></div>`;
                }
                
                html += `</div></div>`;
                if (index < locations.length - 1) html += '<hr class="location-separator">';
            });
        } catch (error) {
            console.error('解析天氣資料失敗:', error);
            html += '<div class="error-data">❌ 解析天氣資料失敗</div>';
        }
        
        return html;
    }

    function formatAlertData(data) {
        let html = '';
        try {
            const records = data.records || {};
            const locations = records.location || [];
            
            if (locations.length === 0) {
                return '<div class="no-data">📭 無特報資料</div>';
            }
            
            let alertCount = 0;
            let tempHtml = '';
            
            locations.forEach((location, index) => {
                const locationName = location.locationName || '未知地區';
                const hazards = location.hazardConditions?.hazards || [];
                
                if (hazards.length > 0) {
                    alertCount += hazards.length;
                    tempHtml += `<div class="alert-card">`;
                    tempHtml += `<h4 class="location-title alert-location">⚠️ ${locationName}</h4>`;
                    tempHtml += `<div class="data-grid">`;
                    
                    hazards.forEach(hazard => {
                        const phenomena = hazard.phenomena || '';
                        const significance = hazard.significance || '';
                        const effectiveTime = hazard.effectiveTime || '';
                        
                        if (phenomena) {
                            const alertIcon = getAlertIcon(phenomena);
                            const alertClass = getAlertClass(phenomena, significance);
                            
                            tempHtml += `<div class="data-item alert-item ${alertClass}">`;
                            tempHtml += `<div class="data-item-label">${alertIcon} 特報類型</div>`;
                            tempHtml += `<div class="data-item-value">${phenomena} ${significance}`;
                            
                            if (effectiveTime) {
                                const timeAgo = getTimeAgo(effectiveTime);
                                tempHtml += `<br><small>生效: ${effectiveTime.substring(0, 16)}<br>${timeAgo}</small>`;
                            }
                            
                            tempHtml += `</div></div>`;
                        }
                    });
                    
                    tempHtml += `</div></div>`;
                    if (index < locations.length - 1) tempHtml += '<hr class="alert-separator">';
                }
            });
            
            if (alertCount > 0) {
                html += `<div class="data-summary alert-summary">⚠️ 發現 ${alertCount} 項特報警訊</div>`;
                html += tempHtml;
            } else {
                html += '<div class="no-data">✅ 目前無特報資料</div>';
            }
            
        } catch (error) {
            console.error('解析特報資料失敗:', error);
            html += '<div class="error-data">❌ 解析特報資料失敗</div>';
        }
        
        return html;
    }

    async function updateData() {
        try {
            const response = await fetch('/api/status');
            const data = await response.json();
            document.getElementById('updateTime').textContent = new Date(data.timestamp).toLocaleString('zh-TW');
            
            // 更新航班風險信息
            const flightRiskLevel = document.getElementById('flightRiskLevel');
            const flightRiskReason = document.getElementById('flightRiskReason');
            if (flightRiskLevel && flightRiskReason) {
                flightRiskLevel.innerHTML = `<span class="risk-${getRiskClass(data.travel_risk)}">${data.travel_risk}</span>`;
                flightRiskReason.textContent = getFlightRiskReason(data);
            }
            
            // 更新體檢風險信息
            const checkupRiskLevel = document.getElementById('checkupRiskLevel');
            const checkupRiskReason = document.getElementById('checkupRiskReason');
            if (checkupRiskLevel && checkupRiskReason) {
                checkupRiskLevel.innerHTML = `<span class="risk-${getRiskClass(data.checkup_risk)}">${data.checkup_risk}</span>`;
                checkupRiskReason.textContent = getCheckupRiskReason(data);
            }
            
            // 更新當前警報
            const currentAlertsDiv = document.getElementById('currentAlerts');
            if (data.warnings.length > 0) {
                let alertsHtml = '';
                data.warnings.forEach(warning => {
                    alertsHtml += `<div class="alert-item">${warning}</div>`;
                });
                currentAlertsDiv.innerHTML = alertsHtml;
            } else {
                currentAlertsDiv.innerHTML = '<div class="no-alerts">✅ 目前無特殊警報</div>';
            }

            await updateRawData();
            
        } catch (error) {
            console.error('更新資料失敗:', error);
        }
    }

    function getFlightRiskReason(data) {
        if (data.travel_risk.includes('高風險')) {
            return '颱風風速過高或暴風圈影響金門機場，可能導致航班取消或延誤';
        } else if (data.travel_risk.includes('中風險')) {
            return '有強風特報或中度颱風影響，建議密切關注航班動態';
        } else {
            return '天氣條件良好，預期正常起降';
        }
    }

    function getCheckupRiskReason(data) {
        if (data.checkup_risk.includes('高風險')) {
            return '颱風直接影響台南地區，建議延後體檢行程確保安全';
        } else if (data.checkup_risk.includes('中風險')) {
            return '有豪雨或強風警報，外出需注意交通安全';
        } else {
            return '天氣狀況穩定，適合進行體檢行程';
        }
    }

    async function updateRawData() {
        try {
            const startTime = Date.now();
            const rawDataResponse = await fetch('/api/raw-data');
            const loadTime = Date.now() - startTime;
            const rawData = await rawDataResponse.json();
            
            // 更新狀態顯示
            updateDataStatus('typhoon', rawData.typhoons);
            updateDataStatus('weather', rawData.weather);
            updateDataStatus('alert', rawData.alerts);
            
            // 更新資料內容
            document.getElementById('typhoonData').innerHTML = formatRawData(rawData.typhoons, 'typhoon');
            document.getElementById('alertData').innerHTML = formatRawData(rawData.alerts, 'alert');
            
            // 分別更新台南和金門的天氣資料
            updateLocationWeatherData(rawData.weather, 'tainanWeatherData', '台南市');
            updateLocationWeatherData(rawData.weather, 'kinmenWeatherData', '金門縣');
            
            // 更新 API 統計
            document.getElementById('apiStatsData').innerHTML = formatApiStats(rawData, loadTime);
            
        } catch (error) {
            console.error('更新原始資料失敗:', error);
            document.getElementById('typhoonData').innerHTML = '<div class="error-data">❌ 資料載入失敗</div>';
            document.getElementById('alertData').innerHTML = '<div class="error-data">❌ 資料載入失敗</div>';
            if (document.getElementById('tainanWeatherData')) {
                document.getElementById('tainanWeatherData').innerHTML = '<div class="error-data">❌ 資料載入失敗</div>';
            }
            if (document.getElementById('kinmenWeatherData')) {
                document.getElementById('kinmenWeatherData').innerHTML = '<div class="error-data">❌ 資料載入失敗</div>';
            }
        }
    }

    function updateLocationWeatherData(weatherData, elementId, locationName) {
        const element = document.getElementById(elementId);
        if (!element) return;
        
        try {
            const records = weatherData.records || {};
            const locations = records.location || [];
            const targetLocation = locations.find(loc => loc.locationName && loc.locationName.includes(locationName));
            
            if (targetLocation) {
                element.innerHTML = formatLocationWeather(targetLocation);
            } else {
                element.innerHTML = `<div class="no-data">📭 無 ${locationName} 天氣資料</div>`;
            }
        } catch (error) {
            console.error(`更新 ${locationName} 天氣資料失敗:`, error);
            element.innerHTML = '<div class="error-data">❌ 資料載入失敗</div>';
        }
    }

    function formatLocationWeather(location) {
        const locationName = location.locationName || '未知地區';
        const elements = location.weatherElement || [];
        
        let html = `<div class="location-weather-card">`;
        html += `<div class="data-grid">`;
        
        // 整理資料結構，方便顯示
        const weatherInfo = {};
        elements.forEach(element => {
            const elementName = element.elementName || '';
            const times = element.time || [];
            
            if (times.length > 0) {
                const latestTime = times[0];
                const value = latestTime.parameter?.parameterName || '';
                const startTime = latestTime.startTime || '';
                
                weatherInfo[elementName] = { value, startTime };
            }
        });
        
        // 按優先順序顯示天氣資訊
        if (weatherInfo.Wx && weatherInfo.Wx.value) {
            const weatherIcon = getWeatherIcon(weatherInfo.Wx.value);
            html += `<div class="data-item weather-phenomenon"><div class="data-item-label">${weatherIcon} 天氣現象</div><div class="data-item-value">${weatherInfo.Wx.value}<br><small>${weatherInfo.Wx.startTime.substring(0, 16)}</small></div></div>`;
        }
        
        if (weatherInfo.PoP && weatherInfo.PoP.value) {
            const rainIcon = getRainIcon(weatherInfo.PoP.value);
            html += `<div class="data-item rain-probability"><div class="data-item-label">${rainIcon} 降雨機率</div><div class="data-item-value">${weatherInfo.PoP.value}%</div></div>`;
        }
        
        // 溫度範圍
        const minTemp = weatherInfo.MinT?.value;
        const maxTemp = weatherInfo.MaxT?.value;
        if (minTemp && maxTemp) {
            const tempIcon = getTempIcon(maxTemp);
            html += `<div class="data-item temperature-range"><div class="data-item-label">${tempIcon} 溫度範圍</div><div class="data-item-value">${minTemp}°C ~ ${maxTemp}°C</div></div>`;
        } else {
            if (minTemp) {
                html += `<div class="data-item"><div class="data-item-label">🌡️ 最低溫度</div><div class="data-item-value">${minTemp}°C</div></div>`;
            }
            if (maxTemp) {
                html += `<div class="data-item"><div class="data-item-label">🌡️ 最高溫度</div><div class="data-item-value">${maxTemp}°C</div></div>`;
            }
        }
        
        if (weatherInfo.CI && weatherInfo.CI.value) {
            const comfortIcon = getComfortIcon(weatherInfo.CI.value);
            html += `<div class="data-item comfort-index"><div class="data-item-label">${comfortIcon} 舒適度</div><div class="data-item-value">${weatherInfo.CI.value}</div></div>`;
        }
        
        html += `</div></div>`;
        return html;
    }

    function updateDataStatus(type, data) {
        const statusElement = document.getElementById(`${type}-status`);
        if (!data || Object.keys(data).length === 0) {
            statusElement.innerHTML = '<span class="status-no-data">無資料</span>';
            return;
        }

        let count = 0;
        if (type === 'typhoon') {
            const typhoons = data.records?.tropicalCyclones?.tropicalCyclone || [];
            count = typhoons.length;
            statusElement.innerHTML = count > 0 ? 
                `<span class="status-active">${count} 個颱風</span>` : 
                '<span class="status-safe">無颱風</span>';
        } else if (type === 'weather') {
            const locations = data.records?.location || [];
            count = locations.length;
            statusElement.innerHTML = count > 0 ? 
                `<span class="status-normal">${count} 地區</span>` : 
                '<span class="status-no-data">無資料</span>';
        } else if (type === 'alert') {
            const locations = data.records?.location || [];
            count = locations.reduce((total, loc) => total + (loc.hazardConditions?.hazards?.length || 0), 0);
            statusElement.innerHTML = count > 0 ? 
                `<span class="status-warning">${count} 項警報</span>` : 
                '<span class="status-safe">無警報</span>';
        }
    }

    function formatApiStats(rawData, loadTime) {
        let html = '<div class="data-grid">';
        
        // API 回應時間
        html += `<div class="data-item"><div class="data-item-label">⚡ API 回應時間</div><div class="data-item-value">${loadTime} ms</div></div>`;
        
        // 資料大小統計
        const dataSize = JSON.stringify(rawData).length;
        const dataSizeKB = (dataSize / 1024).toFixed(2);
        html += `<div class="data-item"><div class="data-item-label">📊 資料大小</div><div class="data-item-value">${dataSizeKB} KB</div></div>`;
        
        // 颱風統計
        const typhoonCount = rawData.typhoons?.records?.tropicalCyclones?.tropicalCyclone?.length || 0;
        html += `<div class="data-item"><div class="data-item-label">🌀 活躍颱風</div><div class="data-item-value">${typhoonCount} 個</div></div>`;
        
        // 監控地區統計
        const weatherLocations = rawData.weather?.records?.location?.length || 0;
        html += `<div class="data-item"><div class="data-item-label">📍 監控地區</div><div class="data-item-value">${weatherLocations} 個</div></div>`;
        
        // 特報統計
        const alertLocations = rawData.alerts?.records?.location || [];
        const totalAlerts = alertLocations.reduce((total, loc) => total + (loc.hazardConditions?.hazards?.length || 0), 0);
        html += `<div class="data-item"><div class="data-item-label">⚠️ 特報數量</div><div class="data-item-value">${totalAlerts} 項</div></div>`;
        
        // 最後更新時間
        const updateTime = new Date().toLocaleString('zh-TW');
        html += `<div class="data-item"><div class="data-item-label">🕐 更新時間</div><div class="data-item-value">${updateTime}</div></div>`;
        
        html += '</div>';
        return html;
    }

    // Helper functions for icons and calculations
    function getWindIcon(windSpeed) {
        if (windSpeed >= 118) return '🌪️';
        if (windSpeed >= 88) return '💨';
        if (windSpeed >= 62) return '🌬️';
        if (windSpeed >= 34) return '🍃';
        return '🌬️';
    }

    function getPressureIcon(pressure) {
        if (pressure < 950) return '🔴';
        if (pressure < 980) return '🟠';
        return '📊';
    }

    function getWeatherIcon(weather) {
        if (weather.includes('晴')) return '☀️';
        if (weather.includes('雲')) return '☁️';
        if (weather.includes('陰')) return '☁️';
        if (weather.includes('雨')) return '🌧️';
        if (weather.includes('雷')) return '⛈️';
        if (weather.includes('霧')) return '🌫️';
        return '🌤️';
    }

    function getRainIcon(probability) {
        if (probability >= 80) return '🌧️';
        if (probability >= 60) return '🌦️';
        if (probability >= 30) return '⛅';
        return '☀️';
    }

    function getTempIcon(temp) {
        if (temp >= 35) return '🥵';
        if (temp >= 25) return '🌡️';
        if (temp >= 15) return '🌡️';
        return '🥶';
    }

    function getComfortIcon(comfort) {
        if (comfort.includes('舒適')) return '😊';
        if (comfort.includes('悶熱')) return '😰';
        if (comfort.includes('寒冷')) return '🥶';
        return '😌';
    }

    function getAlertIcon(phenomena) {
        if (phenomena.includes('颱風')) return '🌪️';
        if (phenomena.includes('強風')) return '💨';
        if (phenomena.includes('豪雨')) return '🌧️';
        if (phenomena.includes('雷電')) return '⛈️';
        return '⚠️';
    }

    function getAlertClass(phenomena, significance) {
        if (phenomena.includes('颱風') || significance.includes('警報')) return 'alert-danger';
        if (phenomena.includes('豪雨') || significance.includes('特報')) return 'alert-warning';
        return 'alert-info';
    }

    function calculateDistanceToTaiwan(lat, lon) {
        // 台灣中心點座標 (大約)
        const taiwanLat = 23.8;
        const taiwanLon = 121.0;
        
        const R = 6371; // 地球半徑 km
        const dLat = (lat - taiwanLat) * Math.PI / 180;
        const dLon = (lon - taiwanLon) * Math.PI / 180;
        const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                  Math.cos(taiwanLat * Math.PI / 180) * Math.cos(lat * Math.PI / 180) *
                  Math.sin(dLon/2) * Math.sin(dLon/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        const distance = R * c;
        
        return Math.round(distance);
    }

    function getTimeAgo(timeString) {
        const now = new Date();
        const time = new Date(timeString);
        const diffMs = now - time;
        const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
        const diffMins = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));
        
        if (diffHours > 0) {
            return `${diffHours} 小時 ${diffMins} 分鐘前`;
        } else {
            return `${diffMins} 分鐘前`;
        }
    }
    function getRiskClass(risk) {
        if (risk.includes('高風險')) return 'high';
        if (risk.includes('中風險')) return 'medium';
        return 'low';
    }

    // Typhoon Map Functions
    function toggleMap() {
        const mapContainer = document.getElementById('mapContainer');
        const toggleBtn = document.getElementById('mapToggleBtn');
        
        if (mapContainer.style.display === 'none') {
            mapContainer.style.display = 'block';
            toggleBtn.textContent = '🗺️ 隱藏地圖';
            toggleBtn.classList.add('active');
            
            // 延遲載入 iframe 以提升性能
            const iframe = document.getElementById('typhoonMap');
            if (!iframe.src || iframe.src === 'about:blank') {
                iframe.src = 'https://app.cwa.gov.tw/web/obsmap/typhoon.html';
            }
        } else {
            mapContainer.style.display = 'none';
            toggleBtn.textContent = '🗺️ 顯示地圖';
            toggleBtn.classList.remove('active');
        }
    }

    function refreshMap() {
        const iframe = document.getElementById('typhoonMap');
        const refreshBtn = document.querySelector('.map-refresh-btn');
        
        refreshBtn.textContent = '⏳ 更新中...';
        refreshBtn.disabled = true;
        
        // 強制重新載入 iframe
        const currentSrc = iframe.src;
        iframe.src = 'about:blank';
        
        setTimeout(() => {
            iframe.src = currentSrc + '?t=' + new Date().getTime(); // 加入時間戳避免快取
            
            iframe.onload = () => {
                refreshBtn.textContent = '✅ 已更新';
                setTimeout(() => {
                    refreshBtn.textContent = '🔄 刷新地圖';
                    refreshBtn.disabled = false;
                }, 2000);
            };
            
            // 如果載入失敗的備用方案
            setTimeout(() => {
                if (refreshBtn.disabled) {
                    refreshBtn.textContent = '🔄 刷新地圖';
                    refreshBtn.disabled = false;
                }
            }, 10000);
        }, 500);
    }

    // 每30秒更新一次
    updateData();
    setInterval(updateData, 30000);
</script>
{% endblock %}