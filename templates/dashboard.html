{% extends "base.html" %}

{% block content %}
<h1>ğŸŒ€ é¢±é¢¨è­¦è¨Šæ’­å ±ç³»çµ±</h1>
<p class="update-time">æœ€å¾Œæ›´æ–°: <span id="updateTime">è¼‰å…¥ä¸­...</span></p>
<div id="status">è¼‰å…¥ä¸­...</div>
<div id="travelRisk">è¼‰å…¥ä¸­...</div>
<div id="checkupRisk">è¼‰å…¥ä¸­...</div>
<div id="warnings">è¼‰å…¥ä¸­...</div>

<!-- æ©Ÿå ´ç›£æ§ç‹€æ…‹æç¤º -->
<div class="disabled-notice">
    <h3>âœˆï¸ æ©Ÿå ´ç›£æ§ç‹€æ…‹</h3>
    <p>æ©Ÿå ´å³æ™‚ç›£æ§åŠŸèƒ½å›  API é™åˆ¶æš«æ™‚ç¦ç”¨ã€‚èˆªç­é¢¨éšªè©•ä¼°åŸºæ–¼å¤©æ°£é å ±é€²è¡Œã€‚</p>
</div>

<!-- åŸå§‹æ°£è±¡è³‡æ–™å€å¡Š -->
<div class="raw-data-section">
    <h2>ğŸ“Š åŸå§‹æ°£è±¡è³‡æ–™</h2>
    
    <!-- é¢±é¢¨è³‡æ–™ -->
    <div class="raw-data-block">
        <button class="collapsible" onclick="toggleContent('typhoon-content')">
            <span>ğŸŒ€</span> é¢±é¢¨è©³ç´°è³‡æ–™
            <span class="toggle-icon" id="typhoon-toggle">â–¶</span>
        </button>
        <div class="content" id="typhoon-content">
            <div id="typhoonData" class="typhoon-data">è¼‰å…¥ä¸­...</div>
        </div>
    </div>

    <!-- å¤©æ°£é å ±è³‡æ–™ -->
    <div class="raw-data-block">
        <button class="collapsible" onclick="toggleContent('weather-content')">
            <span>ğŸŒ¤ï¸</span> å¤©æ°£é å ±è³‡æ–™
            <span class="toggle-icon" id="weather-toggle">â–¶</span>
        </button>
        <div class="content" id="weather-content">
            <div id="weatherData" class="weather-data">è¼‰å…¥ä¸­...</div>
        </div>
    </div>

    <!-- ç‰¹å ±è³‡æ–™ -->
    <div class="raw-data-block">
        <button class="collapsible" onclick="toggleContent('alert-content')">
            <span>âš ï¸</span> å¤©æ°£ç‰¹å ±è³‡æ–™
            <span class="toggle-icon" id="alert-toggle">â–¶</span>
        </button>
        <div class="content" id="alert-content">
            <div id="alertData" class="alert-data">è¼‰å…¥ä¸­...</div>
        </div>
    </div>

    <!-- é¢¨éšªè©•ä¼°èªªæ˜ -->
    <div class="risk-explanation">
        <h3>ğŸ“‹ é¢¨éšªè©•ä¼°ä¾æ“š</h3>
        <ul>
            <li><strong>é¢±é¢¨é¢¨é€Ÿ &gt;80km/h</strong> = é«˜é¢¨éšª</li>
            <li><strong>é¢±é¢¨é¢¨é€Ÿ 60-80km/h</strong> = ä¸­é¢¨éšª</li>
            <li><strong>å¤§é›¨/è±ªé›¨é å ±</strong> = ä¸­-é«˜é¢¨éšª</li>
            <li><strong>å¼·é¢¨ç‰¹å ±</strong> = ä¸­é¢¨éšª</li>
            <li><strong>æš´é¢¨åœˆç¯„åœ</strong> = é«˜åº¦é—œæ³¨</li>
        </ul>
    </div>
</div>

<div class="explain-block">
    <h2>ğŸ” åˆ†æé‚è¼¯èˆ‡æ–¹æ³•èªªæ˜</h2>
    <ul>
        <li><b>å¤©æ°£ç‰¹å ±</b>ï¼šç›´æ¥æ¡ç”¨ä¸­å¤®æ°£è±¡ç½²APIçš„è­¦ç‰¹å ±çµæœï¼Œè‹¥é‡‘é–€æˆ–å°å—æœ‰ã€Œé¢±é¢¨ã€æˆ–ã€Œå¼·é¢¨ã€ç­‰ç¾è±¡ï¼Œå‰‡åˆ—ç‚ºè­¦å ±ã€‚</li>
        <li><b>é¢±é¢¨è·¯å¾‘</b>ï¼š
            <ul>
                <li>è‹¥é¢±é¢¨æœ€å¤§é¢¨é€Ÿ <b>è¶…é60 km/h</b>ï¼Œå‰‡åˆ—ç‚ºè­¦å ±ã€‚</li>
                <li>è‹¥é¢±é¢¨æœ€å¤§é¢¨é€Ÿ <b>è¶…é80 km/h</b>ï¼Œå‰‡åˆ—ç‚ºé«˜é¢¨éšªè­¦å ±ã€‚</li>
                <li>ä½¿ç”¨åœ°ç†ä½ç½®éæ¿¾ï¼Œåªè€ƒæ…®æœƒå½±éŸ¿å°ç£é‡‘é–€åœ°å€çš„é¢±é¢¨ (è·é›¢600kmå…§)ã€‚</li>
                <li>çµåˆé¢¨é€Ÿå¼·åº¦å’Œåœ°ç†è·é›¢é€²è¡Œç¶œåˆè©•ä¼°ã€‚</li>
            </ul>
        </li>
        <li><b>å¤©æ°£é å ±</b>ï¼š
            <ul>
                <li>è‹¥36å°æ™‚å…§é å ±æœ‰ã€Œé¢±é¢¨ã€ã€ã€Œæš´é¢¨ã€ã€ã€Œè±ªé›¨ã€ã€ã€Œå¤§é›¨ã€ç­‰é—œéµå­—ï¼Œå‰‡åˆ—ç‚ºè­¦å ±ã€‚</li>
            </ul>
        </li>
        <li><b>èˆªç­/é«”æª¢é¢¨éšªè©•ä¼°</b>ï¼š
            <ul>
                <li>è‹¥æœ‰é¢±é¢¨è­¦å ±ï¼Œèˆªç­åˆ—ç‚ºã€Œé«˜é¢¨éšªã€ï¼›æœ‰å¼·é¢¨å‰‡ç‚ºã€Œä¸­é¢¨éšªã€ã€‚</li>
                <li>å°å—æœ‰é¢±é¢¨è­¦å ±ï¼Œé«”æª¢åˆ—ç‚ºã€Œé«˜é¢¨éšªã€ï¼›æœ‰å¼·é¢¨æˆ–è±ªé›¨å‰‡ç‚ºã€Œä¸­é¢¨éšªã€ã€‚</li>
                <li>é«”æª¢é¢¨éšªè©•ä¼°çµåˆåœ°ç†ä½ç½®åˆ†æå’ŒåŸºæœ¬é¢¨éšªè©•ä¼°ã€‚</li>
            </ul>
        </li>
    </ul>
    <p style="color:#555;font-size:14px;">
        æ©Ÿå ´å³æ™‚ç›£æ§åŠŸèƒ½å›  API é™åˆ¶æš«æ™‚ç¦ç”¨ã€‚æ‰€æœ‰åˆ†æè¦å‰‡å¯æ–¼ç¨‹å¼ç¢¼å…§å„åˆ†ææ–¹æ³•æŸ¥é–±èˆ‡èª¿æ•´ã€‚
    </p>
</div>

<script>
    function toggleContent(contentId) {
        const content = document.getElementById(contentId);
        const toggleIcon = document.getElementById(contentId.replace('-content', '-toggle'));
        
        if (content.classList.contains('show')) {
            content.classList.remove('show');
            toggleIcon.classList.remove('rotated');
        } else {
            content.classList.add('show');
            toggleIcon.classList.add('rotated');
        }
    }

    function formatRawData(data, type) {
        if (!data || Object.keys(data).length === 0) {
            return '<div class="no-data">ç›®å‰ç„¡è³‡æ–™</div>';
        }

        if (type === 'typhoon') {
            return formatTyphoonData(data);
        } else if (type === 'weather') {
            return formatWeatherData(data);
        } else if (type === 'alert') {
            return formatAlertData(data);
        }
        
        return '<div class="no-data">ç„¡æ³•è§£æè³‡æ–™</div>';
    }

    function formatTyphoonData(data) {
        let html = '';
        try {
            const records = data.records || {};
            
            if (records.tropicalCyclones && records.tropicalCyclones.tropicalCyclone) {
                const typhoons = records.tropicalCyclones.tropicalCyclone;
                
                typhoons.forEach((typhoon, index) => {
                    const name = typhoon.cwaTyphoonName || typhoon.typhoonName || 'æœªçŸ¥ç†±å¸¶æ°£æ—‹';
                    const tyNo = typhoon.cwaTyNo || typhoon.cwaTdNo || '';
                    
                    html += `<div class="data-grid">`;
                    html += `<div class="data-item"><div class="data-item-label">ğŸŒ€ é¢±é¢¨åç¨±</div><div class="data-item-value">${name}</div></div>`;
                    
                    if (tyNo) {
                        html += `<div class="data-item"><div class="data-item-label">ğŸ·ï¸ ç·¨è™Ÿ</div><div class="data-item-value">${tyNo}</div></div>`;
                    }
                    
                    const analysisData = typhoon.analysisData || {};
                    const fixes = analysisData.fix || [];
                    
                    if (fixes.length > 0) {
                        const latestFix = fixes[fixes.length - 1];
                        
                        if (latestFix.maxWindSpeed) {
                            const windKmh = (parseInt(latestFix.maxWindSpeed) * 3.6).toFixed(1);
                            html += `<div class="data-item"><div class="data-item-label">ğŸ’¨ æœ€å¤§é¢¨é€Ÿ</div><div class="data-item-value">${latestFix.maxWindSpeed} m/s (${windKmh} km/h)</div></div>`;
                        }
                        
                        if (latestFix.maxGustSpeed) {
                            const gustKmh = (parseInt(latestFix.maxGustSpeed) * 3.6).toFixed(1);
                            html += `<div class="data-item"><div class="data-item-label">ğŸ’¨ æœ€å¤§é™£é¢¨</div><div class="data-item-value">${latestFix.maxGustSpeed} m/s (${gustKmh} km/h)</div></div>`;
                        }
                        
                        if (latestFix.pressure) {
                            html += `<div class="data-item"><div class="data-item-label">ğŸ“Š ä¸­å¿ƒæ°£å£“</div><div class="data-item-value">${latestFix.pressure} hPa</div></div>`;
                        }
                        
                        if (latestFix.movingSpeed) {
                            html += `<div class="data-item"><div class="data-item-label">ğŸƒ ç§»å‹•é€Ÿåº¦</div><div class="data-item-value">${latestFix.movingSpeed} km/h</div></div>`;
                        }
                        
                        if (latestFix.movingDirection) {
                            const directionMap = {
                                'N': 'åŒ—', 'NNE': 'åŒ—åŒ—æ±', 'NE': 'æ±åŒ—', 'ENE': 'æ±åŒ—æ±',
                                'E': 'æ±', 'ESE': 'æ±å—æ±', 'SE': 'æ±å—', 'SSE': 'å—å—æ±',
                                'S': 'å—', 'SSW': 'å—å—è¥¿', 'SW': 'è¥¿å—', 'WSW': 'è¥¿å—è¥¿',
                                'W': 'è¥¿', 'WNW': 'è¥¿åŒ—è¥¿', 'NW': 'è¥¿åŒ—', 'NNW': 'åŒ—åŒ—è¥¿'
                            };
                            const directionZh = directionMap[latestFix.movingDirection] || latestFix.movingDirection;
                            html += `<div class="data-item"><div class="data-item-label">â¡ï¸ ç§»å‹•æ–¹å‘</div><div class="data-item-value">${directionZh}</div></div>`;
                        }
                        
                        if (latestFix.coordinate) {
                            try {
                                const [lon, lat] = latestFix.coordinate.split(',');
                                html += `<div class="data-item"><div class="data-item-label">ğŸ“ åº§æ¨™ä½ç½®</div><div class="data-item-value">${lat}Â°N, ${lon}Â°E</div></div>`;
                            } catch (e) {
                                html += `<div class="data-item"><div class="data-item-label">ğŸ“ åº§æ¨™ä½ç½®</div><div class="data-item-value">${latestFix.coordinate}</div></div>`;
                            }
                        }
                        
                        if (latestFix.circleOf15Ms && latestFix.circleOf15Ms.radius) {
                            html += `<div class="data-item"><div class="data-item-label">ğŸŒªï¸ æš´é¢¨åœˆåŠå¾‘</div><div class="data-item-value">${latestFix.circleOf15Ms.radius} km</div></div>`;
                        }
                        
                        if (latestFix.fixTime) {
                            html += `<div class="data-item"><div class="data-item-label">ğŸ• è§€æ¸¬æ™‚é–“</div><div class="data-item-value">${latestFix.fixTime.substring(0, 16)}</div></div>`;
                        }
                    }
                    
                    html += `</div>`;
                    if (index < typhoons.length - 1) html += '<hr style="margin: 20px 0;">';
                });
            } else {
                html = '<div class="no-data">ğŸŒ€ ç›®å‰ç„¡æ´»èºé¢±é¢¨</div>';
            }
        } catch (error) {
            console.error('è§£æé¢±é¢¨è³‡æ–™å¤±æ•—:', error);
            html = '<div class="no-data">è§£æé¢±é¢¨è³‡æ–™å¤±æ•—</div>';
        }
        
        return html;
    }

    function formatWeatherData(data) {
        let html = '';
        try {
            const records = data.records || {};
            const locations = records.location || [];
            
            if (locations.length === 0) {
                return '<div class="no-data">ç„¡å¤©æ°£é å ±è³‡æ–™</div>';
            }
            
            locations.forEach((location, index) => {
                const locationName = location.locationName || 'æœªçŸ¥åœ°å€';
                const elements = location.weatherElement || [];
                
                html += `<h4>${locationName}</h4>`;
                html += `<div class="data-grid">`;
                
                elements.forEach(element => {
                    const elementName = element.elementName || '';
                    const times = element.time || [];
                    
                    if (times.length > 0) {
                        const latestTime = times[0];
                        const value = latestTime.parameter?.parameterName || '';
                        const startTime = latestTime.startTime || '';
                        
                        if (elementName === 'Wx' && value) {
                            html += `<div class="data-item"><div class="data-item-label">ğŸŒ¤ï¸ å¤©æ°£ç¾è±¡</div><div class="data-item-value">${value}</div></div>`;
                            html += `<div class="data-item"><div class="data-item-label">ğŸ• é å ±æ™‚é–“</div><div class="data-item-value">${startTime.substring(0, 16)}</div></div>`;
                        } else if (elementName === 'PoP' && value) {
                            html += `<div class="data-item"><div class="data-item-label">ğŸŒ§ï¸ é™é›¨æ©Ÿç‡</div><div class="data-item-value">${value}%</div></div>`;
                        } else if (elementName === 'MinT' && value) {
                            html += `<div class="data-item"><div class="data-item-label">ğŸŒ¡ï¸ æœ€ä½æº«åº¦</div><div class="data-item-value">${value}Â°C</div></div>`;
                        } else if (elementName === 'MaxT' && value) {
                            html += `<div class="data-item"><div class="data-item-label">ğŸŒ¡ï¸ æœ€é«˜æº«åº¦</div><div class="data-item-value">${value}Â°C</div></div>`;
                        } else if (elementName === 'CI' && value) {
                            html += `<div class="data-item"><div class="data-item-label">ğŸ˜Œ èˆ’é©åº¦</div><div class="data-item-value">${value}</div></div>`;
                        }
                    }
                });
                
                html += `</div>`;
                if (index < locations.length - 1) html += '<hr style="margin: 20px 0;">';
            });
        } catch (error) {
            console.error('è§£æå¤©æ°£è³‡æ–™å¤±æ•—:', error);
            html = '<div class="no-data">è§£æå¤©æ°£è³‡æ–™å¤±æ•—</div>';
        }
        
        return html;
    }

    function formatAlertData(data) {
        let html = '';
        try {
            const records = data.records || {};
            const locations = records.location || [];
            
            if (locations.length === 0) {
                return '<div class="no-data">ç„¡ç‰¹å ±è³‡æ–™</div>';
            }
            
            locations.forEach((location, index) => {
                const locationName = location.locationName || 'æœªçŸ¥åœ°å€';
                const hazards = location.hazardConditions?.hazards || [];
                
                if (hazards.length > 0) {
                    html += `<h4>${locationName}</h4>`;
                    html += `<div class="data-grid">`;
                    
                    hazards.forEach(hazard => {
                        const phenomena = hazard.phenomena || '';
                        const significance = hazard.significance || '';
                        const effectiveTime = hazard.effectiveTime || '';
                        
                        if (phenomena) {
                            html += `<div class="data-item"><div class="data-item-label">ğŸ“¢ ç‰¹å ±é¡å‹</div><div class="data-item-value">${phenomena} ${significance}</div></div>`;
                            if (effectiveTime) {
                                html += `<div class="data-item"><div class="data-item-label">ğŸ• ç”Ÿæ•ˆæ™‚é–“</div><div class="data-item-value">${effectiveTime.substring(0, 16)}</div></div>`;
                            }
                        }
                    });
                    
                    html += `</div>`;
                }
                
                if (index < locations.length - 1) html += '<hr style="margin: 20px 0;">';
            });
            
            if (html === '') {
                html = '<div class="no-data">ç›®å‰ç„¡ç‰¹å ±è³‡æ–™</div>';
            }
        } catch (error) {
            console.error('è§£æç‰¹å ±è³‡æ–™å¤±æ•—:', error);
            html = '<div class="no-data">è§£æç‰¹å ±è³‡æ–™å¤±æ•—</div>';
        }
        
        return html;
    }

    async function updateData() {
        try {
            const response = await fetch('/api/status');
            const data = await response.json();
            document.getElementById('updateTime').textContent = new Date(data.timestamp).toLocaleString('zh-TW');
            const statusDiv = document.getElementById('status');
            if (data.status === 'DANGER') {
                statusDiv.innerHTML = '<div class="status-danger">ğŸ”´ è­¦å‘Šç‹€æ…‹: æœ‰é¢¨éšª</div>';
            } else {
                statusDiv.innerHTML = '<div class="status-safe">ğŸŸ¢ å®‰å…¨ç‹€æ…‹: ç„¡æ˜é¡¯é¢¨éšª</div>';
            }
            document.getElementById('travelRisk').innerHTML = `<p>âœˆï¸ 7/6 é‡‘é–€â†’å°å—èˆªç­é¢¨éšª: <span class="risk-${getRiskClass(data.travel_risk)}">${data.travel_risk}</span></p>`;
            document.getElementById('checkupRisk').innerHTML = `<p>ğŸ¥ 7/7 å°å—é«”æª¢é¢¨éšª: <span class="risk-${getRiskClass(data.checkup_risk)}">${data.checkup_risk}</span></p>`;
            const warningsDiv = document.getElementById('warnings');
            if (data.warnings.length > 0) {
                warningsDiv.innerHTML = '<h3>ğŸ“¢ ç›®å‰è­¦å ±:</h3>' + 
                    data.warnings.map(w => `<div class="warning-item">${w}</div>`).join('');
            } else {
                warningsDiv.innerHTML = '<h3>âœ… ç›®å‰ç„¡ç‰¹æ®Šè­¦å ±</h3>';
            }

            // æ›´æ–°åŸå§‹è³‡æ–™
            const rawDataResponse = await fetch('/api/raw-data');
            const rawData = await rawDataResponse.json();
            
            document.getElementById('typhoonData').innerHTML = formatRawData(rawData.typhoons, 'typhoon');
            document.getElementById('weatherData').innerHTML = formatRawData(rawData.weather, 'weather');
            document.getElementById('alertData').innerHTML = formatRawData(rawData.alerts, 'alert');
            
        } catch (error) {
            console.error('æ›´æ–°è³‡æ–™å¤±æ•—:', error);
        }
    }
    function getRiskClass(risk) {
        if (risk.includes('é«˜é¢¨éšª')) return 'high';
        if (risk.includes('ä¸­é¢¨éšª')) return 'medium';
        return 'low';
    }
    // æ¯30ç§’æ›´æ–°ä¸€æ¬¡
    updateData();
    setInterval(updateData, 30000);
</script>
{% endblock %}