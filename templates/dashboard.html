{% extends "base.html" %}

{% block content %}
<h1>ğŸŒ€ é¢±é¢¨è­¦è¨Šæ’­å ±ç³»çµ±</h1>
<p class="update-time">æœ€å¾Œæ›´æ–°: <span id="updateTime">è¼‰å…¥ä¸­...</span></p>

<!-- è­¦å‘Šç‹€æ…‹å€å¡Š -->
<section class="warning-status-section">
    <h2>âš ï¸ è­¦å‘Šç‹€æ…‹</h2>
    
    <div class="risk-cards">
        <div class="risk-card flight-risk">
            <h3>âœˆï¸ 7/6 é‡‘é–€ â†’ å°å—èˆªç­</h3>
            <div class="risk-info">
                <div class="risk-level">
                    <span class="risk-label">é¢¨éšªç­‰ç´šï¼š</span>
                    <span id="flightRiskLevel" class="risk-value">è¼‰å…¥ä¸­...</span>
                </div>
                <div class="risk-reason">
                    <span class="reason-label">åŸå› ï¼š</span>
                    <span id="flightRiskReason" class="reason-value">è¼‰å…¥ä¸­...</span>
                </div>
            </div>
        </div>
        
        <div class="risk-card checkup-risk">
            <h3>ğŸ¥ 7/7 å°å—é«”æª¢</h3>
            <div class="risk-info">
                <div class="risk-level">
                    <span class="risk-label">é¢¨éšªç­‰ç´šï¼š</span>
                    <span id="checkupRiskLevel" class="risk-value">è¼‰å…¥ä¸­...</span>
                </div>
                <div class="risk-reason">
                    <span class="reason-label">åŸå› ï¼š</span>
                    <span id="checkupRiskReason" class="reason-value">è¼‰å…¥ä¸­...</span>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- ç›®å‰è­¦å ±å€å¡Š -->
<section class="current-alerts-section">
    <h2>ğŸ“¢ ç›®å‰è­¦å ±</h2>
    <div id="currentAlerts" class="alerts-container">è¼‰å…¥ä¸­...</div>
</section>

<!-- ä¸­å¤®æ°£è±¡ç½²é¢±é¢¨è§€æ¸¬åœ°åœ– -->
<section class="typhoon-map-section">
    <h2>ğŸ—ºï¸ ä¸­å¤®æ°£è±¡ç½²é¢±é¢¨è§€æ¸¬åœ°åœ–</h2>
    <div class="map-controls">
        <button onclick="toggleMap()" class="map-toggle-btn" id="mapToggleBtn">ğŸ—ºï¸ é¡¯ç¤ºåœ°åœ–</button>
        <button onclick="refreshMap()" class="map-refresh-btn">ğŸ”„ åˆ·æ–°åœ°åœ–</button>
        <a href="https://app.cwa.gov.tw/web/obsmap/typhoon.html" target="_blank" class="map-external-btn">ğŸ”— åœ¨æ–°è¦–çª—é–‹å•Ÿ</a>
    </div>
    <div class="map-container" id="mapContainer" style="display: none;">
        <iframe id="typhoonMap" 
                src="https://app.cwa.gov.tw/web/obsmap/typhoon.html"
                width="100%" 
                height="600" 
                frameborder="0"
                scrolling="auto"
                loading="lazy"
                title="ä¸­å¤®æ°£è±¡ç½²é¢±é¢¨è§€æ¸¬åœ°åœ–">
            <p>æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´ iframeã€‚è«‹ <a href="https://app.cwa.gov.tw/web/obsmap/typhoon.html" target="_blank">é»æ“Šé€™è£¡</a> åœ¨æ–°è¦–çª—é–‹å•Ÿé¢±é¢¨è§€æ¸¬åœ°åœ–ã€‚</p>
        </iframe>
    </div>
</section>

<hr class="section-divider">

<!-- åŸå§‹æ°£è±¡è³‡æ–™å€å¡Š -->
<section class="raw-data-section">
    <h2>ğŸ“Š åŸå§‹è³‡æ–™</h2>
    <div class="data-controls">
        <button onclick="refreshRawData()" class="refresh-btn">ğŸ”„ åˆ·æ–°è³‡æ–™</button>
        <button onclick="expandAll()" class="expand-btn">ğŸ“– å±•é–‹å…¨éƒ¨</button>
        <button onclick="collapseAll()" class="collapse-btn">ğŸ“˜ æ”¶èµ·å…¨éƒ¨</button>
    </div>

    <!-- å¤©æ°£ç‰¹å ±è³‡æ–™ -->
    <div class="raw-data-block alert-block">
        <button class="collapsible" onclick="toggleContent('alert-content')">
            <span>âš ï¸</span> å¤©æ°£ç‰¹å ±
            <span class="data-status" id="alert-status">è¼‰å…¥ä¸­...</span>
            <span class="toggle-icon" id="alert-toggle">â–¶</span>
        </button>
        <div class="content" id="alert-content">
            <div id="alertData" class="alert-data">è¼‰å…¥ä¸­...</div>
        </div>
    </div>

    <!-- å¤©æ°£é å ±è³‡æ–™ -->
    <div class="raw-data-block weather-block">
        <button class="collapsible" onclick="toggleContent('weather-content')">
            <span>ğŸŒ¤ï¸</span> å¤©æ°£é å ±è³‡æ–™
            <span class="data-status" id="weather-status">è¼‰å…¥ä¸­...</span>
            <span class="toggle-icon" id="weather-toggle">â–¶</span>
        </button>
        <div class="content" id="weather-content">
            <div class="weather-locations">
                <h4>ğŸ“ å°å— 7/5 - 7/10 è©³ç´°å¤©æ°£é å ±</h4>
                <div id="tainanWeatherData" class="location-weather-data">è¼‰å…¥ä¸­...</div>
                
                <h4>ğŸ“ é‡‘é–€ 7/5 - 7/10 è©³ç´°å¤©æ°£é å ±</h4>
                <div id="kinmenWeatherData" class="location-weather-data">è¼‰å…¥ä¸­...</div>
            </div>
        </div>
    </div>

    <!-- é¢±é¢¨è©³ç´°è³‡æ–™ -->
    <div class="raw-data-block typhoon-block">
        <button class="collapsible" onclick="toggleContent('typhoon-content')">
            <span>ğŸŒ€</span> é¢±é¢¨è©³ç´°è³‡æ–™
            <span class="data-status" id="typhoon-status">è¼‰å…¥ä¸­...</span>
            <span class="toggle-icon" id="typhoon-toggle">â–¶</span>
        </button>
        <div class="content" id="typhoon-content">
            <div id="typhoonData" class="typhoon-data">è¼‰å…¥ä¸­...</div>
        </div>
    </div>
</section>

<hr class="section-divider">

<!-- åˆ†æä¾æ“šå€å¡Š -->
<section class="analysis-criteria-section">
    <h2>ğŸ“‹ åˆ†æä¾æ“š</h2>
<!-- åˆ†æä¾æ“šå€å¡Š -->
<section class="analysis-criteria-section">
    <h2>ğŸ“‹ åˆ†æä¾æ“š</h2>
    
    <!-- èˆªç­é¢¨éšªè©•ä¼°ä¾æ“š -->
    <div class="criteria-block flight-criteria">
        <h3>âœˆï¸ èˆªç­é¢¨éšªè©•ä¼°ä¾æ“š</h3>
        
        <div class="criteria-content">
            <h4>ğŸ›¬ æ©Ÿå‹å´é¢¨é™åˆ¶æ¨™æº–</h4>
            <ul>
                <li><strong>A321 (Airbus A321)</strong>ï¼šæœ€å¤§å´é¢¨é™åˆ¶ <span class="risk-high">38ç¯€ (70km/h)</span></li>
                <li><strong>AT7 (ATR 72)</strong>ï¼šæœ€å¤§å´é¢¨é™åˆ¶ <span class="risk-high">35ç¯€ (65km/h)</span></li>
            </ul>
            
            <h4>ğŸŒªï¸ èˆªç­é¢¨éšªç­‰ç´šåˆ¤å®š</h4>
            <ul>
                <li><strong>é«˜é¢¨éšª</strong>ï¼šå´é¢¨ > 35ç¯€ æˆ– é¢±é¢¨é¢¨é€Ÿ > 80km/h æˆ– æš´é¢¨åœˆå½±éŸ¿é‡‘é–€æ©Ÿå ´</li>
                <li><strong>ä¸­é¢¨éšª</strong>ï¼šå´é¢¨ 25-35ç¯€ æˆ– é¢±é¢¨é¢¨é€Ÿ 60-80km/h æˆ– å¼·é¢¨ç‰¹å ±</li>
                <li><strong>ä½é¢¨éšª</strong>ï¼šå´é¢¨ < 25ç¯€ ä¸” ç„¡é¢±é¢¨å¨è„…</li>
            </ul>
            
            <h4>ğŸŒ§ï¸ å¤©æ°£å› å­å½±éŸ¿</h4>
            <ul>
                <li><strong>è±ªé›¨/å¤§é›¨ç‰¹å ±</strong>ï¼šèƒ½è¦‹åº¦é™ä½ï¼Œå½±éŸ¿èµ·é™å®‰å…¨</li>
                <li><strong>é›·é›¨èƒæ´»å‹•</strong>ï¼šå¯èƒ½é€ æˆèˆªç­å»¶èª¤æˆ–æ”¹é™</li>
                <li><strong>æ¿ƒéœ§</strong>ï¼šåš´é‡å½±éŸ¿æ©Ÿå ´ä½œæ¥­</li>
            </ul>
            
            <p class="safety-note">
                <strong>âš ï¸ èˆªç­å®‰å…¨æé†’ï¼š</strong>è¶…éå´é¢¨é™åˆ¶æ™‚ï¼Œæ©Ÿå¸«å¯é¸æ“‡é‡é£›æˆ–æ”¹é™å…¶ä»–æ©Ÿå ´ã€‚
                èˆªç©ºå…¬å¸äº¦å¯èƒ½åŸºæ–¼å®‰å…¨è€ƒé‡ï¼Œä¸»å‹•èª¿æ•´èµ·é™æ¨™æº–æˆ–å–æ¶ˆèˆªç­ã€‚
            </p>
        </div>
    </div>
    
    <!-- é«”æª¢é¢¨éšªè©•ä¼°ä¾æ“š -->
    <div class="criteria-block checkup-criteria">
        <h3>ğŸ¥ é«”æª¢é¢¨éšªè©•ä¼°ä¾æ“š</h3>
        
        <div class="criteria-content">
            <h4>ğŸŒ€ é¢±é¢¨å½±éŸ¿è©•ä¼°</h4>
            <ul>
                <li><strong>é«˜é¢¨éšª</strong>ï¼šé¢±é¢¨é¢¨é€Ÿ > 80km/h æˆ– æš´é¢¨åœˆå½±éŸ¿å°å—åœ°å€</li>
                <li><strong>ä¸­é¢¨éšª</strong>ï¼šé¢±é¢¨é¢¨é€Ÿ 60-80km/h æˆ– è±ªé›¨ç‰¹å ±å½±éŸ¿å°å—</li>
                <li><strong>ä½é¢¨éšª</strong>ï¼šé¢±é¢¨è·é›¢å°å— > 600km ä¸”é¢¨é€Ÿ < 60km/h</li>
            </ul>
            
            <h4>ğŸŒ§ï¸ å¤©æ°£è­¦å ±å½±éŸ¿</h4>
            <ul>
                <li><strong>è±ªé›¨ç‰¹å ±</strong>ï¼šå¯èƒ½é€ æˆäº¤é€šä¸­æ–·ï¼Œå½±éŸ¿é«”æª¢è¡Œç¨‹</li>
                <li><strong>å¼·é¢¨ç‰¹å ±</strong>ï¼šæˆ¶å¤–æ´»å‹•é¢¨éšªå¢åŠ </li>
                <li><strong>é›·é›¨è­¦å ±</strong>ï¼šå»ºè­°é¿å…å¤–å‡ºæˆ–å»¶å¾Œé«”æª¢</li>
            </ul>
            
            <h4>ğŸš— äº¤é€šå®‰å…¨è€ƒé‡</h4>
            <ul>
                <li><strong>é“è·¯ç©æ°´</strong>ï¼šè±ªé›¨å¯èƒ½é€ æˆå¸‚å€é“è·¯ç©æ°´</li>
                <li><strong>å¼·é¢¨å½±éŸ¿</strong>ï¼šå´é¢¨å¯èƒ½å½±éŸ¿é§•é§›å®‰å…¨</li>
                <li><strong>èƒ½è¦‹åº¦</strong>ï¼šå¤§é›¨æˆ–æ¿ƒéœ§å½±éŸ¿è¡Œè»Šè¦–ç·š</li>
            </ul>
            
            <p class="safety-note">
                <strong>âš ï¸ é«”æª¢å®‰å…¨æé†’ï¼š</strong>é‡æƒ¡åŠ£å¤©æ°£å»ºè­°å»¶å¾Œé«”æª¢è¡Œç¨‹ï¼Œç¢ºä¿å¾€è¿”äº¤é€šå®‰å…¨ã€‚
                å¯å½ˆæ€§èª¿æ•´é«”æª¢æ™‚é–“ï¼Œä»¥é¿é–‹å¤©æ°£é«˜é¢¨éšªæ™‚æ®µã€‚
            </p>
        </div>
    </div>
</section>

<hr class="section-divider">

<!-- è³‡æ–™ä¾†æºèˆ‡æ•´ç†æ–¹æ³• -->
<section class="methodology-section">
    <h2>ğŸ“‹ è³‡æ–™ä¾†æºèˆ‡æ•´ç†æ–¹æ³•</h2>
    
    <div class="methodology-content">
        <h3>ï¿½ åˆ†æé‚è¼¯èˆ‡æ–¹æ³•èªªæ˜</h3>
        <ul>
            <li><b>å¤©æ°£ç‰¹å ±</b>ï¼šç›´æ¥æ¡ç”¨ä¸­å¤®æ°£è±¡ç½²APIçš„è­¦ç‰¹å ±çµæœï¼Œè‹¥é‡‘é–€æˆ–å°å—æœ‰ã€Œé¢±é¢¨ã€æˆ–ã€Œå¼·é¢¨ã€ç­‰ç¾è±¡ï¼Œå‰‡åˆ—ç‚ºè­¦å ±ã€‚</li>
            <li><b>é¢±é¢¨è·¯å¾‘</b>ï¼š
                <ul>
                    <li>è‹¥é¢±é¢¨æœ€å¤§é¢¨é€Ÿ <b>è¶…é60 km/h</b>ï¼Œå‰‡åˆ—ç‚ºè­¦å ±ã€‚</li>
                    <li>è‹¥é¢±é¢¨æœ€å¤§é¢¨é€Ÿ <b>è¶…é80 km/h</b>ï¼Œå‰‡åˆ—ç‚ºé«˜é¢¨éšªè­¦å ±ã€‚</li>
                    <li>ä½¿ç”¨åœ°ç†ä½ç½®éæ¿¾ï¼Œåªè€ƒæ…®æœƒå½±éŸ¿å°ç£é‡‘é–€åœ°å€çš„é¢±é¢¨ (è·é›¢600kmå…§)ã€‚</li>
                    <li>çµåˆé¢¨é€Ÿå¼·åº¦å’Œåœ°ç†è·é›¢é€²è¡Œç¶œåˆè©•ä¼°ã€‚</li>
                </ul>
            </li>
            <li><b>å¤©æ°£é å ±</b>ï¼š
                <ul>
                    <li>è‹¥36å°æ™‚å…§é å ±æœ‰ã€Œé¢±é¢¨ã€ã€ã€Œæš´é¢¨ã€ã€ã€Œè±ªé›¨ã€ã€ã€Œå¤§é›¨ã€ç­‰é—œéµå­—ï¼Œå‰‡åˆ—ç‚ºè­¦å ±ã€‚</li>
                </ul>
            </li>
            <li><b>èˆªç­/é«”æª¢é¢¨éšªè©•ä¼°</b>ï¼š
                <ul>
                    <li>è‹¥æœ‰é¢±é¢¨è­¦å ±ï¼Œèˆªç­åˆ—ç‚ºã€Œé«˜é¢¨éšªã€ï¼›æœ‰å¼·é¢¨å‰‡ç‚ºã€Œä¸­é¢¨éšªã€ã€‚</li>
                    <li>å°å—æœ‰é¢±é¢¨è­¦å ±ï¼Œé«”æª¢åˆ—ç‚ºã€Œé«˜é¢¨éšªã€ï¼›æœ‰å¼·é¢¨æˆ–è±ªé›¨å‰‡ç‚ºã€Œä¸­é¢¨éšªã€ã€‚</li>
                    <li>é«”æª¢é¢¨éšªè©•ä¼°çµåˆåœ°ç†ä½ç½®åˆ†æå’ŒåŸºæœ¬é¢¨éšªè©•ä¼°ã€‚</li>
                </ul>
            </li>
        </ul>
        
        <div class="api-notice">
            <p><strong>ğŸ“ é‡è¦èªªæ˜ï¼š</strong></p>
            <ul>
                <li>æ©Ÿå ´å³æ™‚ç›£æ§åŠŸèƒ½å›  API é™åˆ¶æš«æ™‚ç¦ç”¨ã€‚èˆªç­é¢¨éšªè©•ä¼°åŸºæ–¼å¤©æ°£é å ±é€²è¡Œã€‚</li>
                <li>æ‰€æœ‰åˆ†æè¦å‰‡å¯æ–¼ç¨‹å¼ç¢¼å…§å„åˆ†ææ–¹æ³•æŸ¥é–±èˆ‡èª¿æ•´ã€‚</li>
                <li>è³‡æ–™ä¾†æºï¼šä¸­å¤®æ°£è±¡ç½²é–‹æ”¾è³‡æ–™å¹³è‡º</li>
            </ul>
        </div>
    </div>
</section>

<hr class="section-divider">

<!-- API è³‡æ–™çµ±è¨ˆ -->
<section class="api-stats-section">
    <h2>ğŸ“Š API è³‡æ–™çµ±è¨ˆ</h2>
    <div class="raw-data-block api-stats-block">
        <button class="collapsible" onclick="toggleContent('api-stats-content')">
            <span>ğŸ“Š</span> API çµ±è¨ˆè³‡è¨Š
            <span class="data-status" id="api-stats-status">è¼‰å…¥ä¸­...</span>
            <span class="toggle-icon" id="api-stats-toggle">â–¶</span>
        </button>
        <div class="content" id="api-stats-content">
            <div id="apiStatsData" class="api-stats-data">è¼‰å…¥ä¸­...</div>
        </div>
    </div>
</section>

<script>
    function toggleContent(contentId) {
        const content = document.getElementById(contentId);
        const toggleIcon = document.getElementById(contentId.replace('-content', '-toggle'));
        
        if (content.classList.contains('show')) {
            content.classList.remove('show');
            toggleIcon.classList.remove('rotated');
        } else {
            content.classList.add('show');
            toggleIcon.classList.add('rotated');
        }
    }

    function expandAll() {
        ['typhoon-content', 'alert-content', 'api-stats-content'].forEach(contentId => {
            const content = document.getElementById(contentId);
            const toggleIcon = document.getElementById(contentId.replace('-content', '-toggle'));
            if (content && toggleIcon) {
                content.classList.add('show');
                toggleIcon.classList.add('rotated');
            }
        });
    }

    function collapseAll() {
        ['typhoon-content', 'alert-content', 'api-stats-content'].forEach(contentId => {
            const content = document.getElementById(contentId);
            const toggleIcon = document.getElementById(contentId.replace('-content', '-toggle'));
            if (content && toggleIcon) {
                content.classList.remove('show');
                toggleIcon.classList.remove('rotated');
            }
        });
    }

    async function refreshRawData() {
        const refreshBtn = document.querySelector('.refresh-btn');
        refreshBtn.textContent = 'â³ æ›´æ–°ä¸­...';
        refreshBtn.disabled = true;
        
        try {
            await updateRawData();
            refreshBtn.textContent = 'âœ… å·²æ›´æ–°';
            setTimeout(() => {
                refreshBtn.textContent = 'ğŸ”„ åˆ·æ–°è³‡æ–™';
                refreshBtn.disabled = false;
            }, 2000);
        } catch (error) {
            refreshBtn.textContent = 'âŒ æ›´æ–°å¤±æ•—';
            setTimeout(() => {
                refreshBtn.textContent = 'ğŸ”„ åˆ·æ–°è³‡æ–™';
                refreshBtn.disabled = false;
            }, 2000);
        }
    }

    function formatRawData(data, type) {
        if (!data || Object.keys(data).length === 0) {
            return '<div class="no-data">ğŸ“­ ç›®å‰ç„¡è³‡æ–™</div>';
        }

        const timestamp = new Date().toLocaleString('zh-TW');
        let html = `<div class="data-timestamp">ğŸ“… è³‡æ–™æ™‚é–“: ${timestamp}</div>`;

        if (type === 'typhoon') {
            html += formatTyphoonData(data);
        } else if (type === 'weather') {
            html += formatWeatherData(data);
        } else if (type === 'alert') {
            html += formatAlertData(data);
        }
        
        return html || '<div class="no-data">â“ ç„¡æ³•è§£æè³‡æ–™</div>';
    }

    function formatTyphoonData(data) {
        let html = '';
        try {
            const records = data.records || {};
            
            if (records.tropicalCyclones && records.tropicalCyclones.tropicalCyclone) {
                const typhoons = records.tropicalCyclones.tropicalCyclone;
                
                html += `<div class="data-summary">ğŸŒ€ ç™¼ç¾ ${typhoons.length} å€‹ç†±å¸¶æ°£æ—‹</div>`;
                
                typhoons.forEach((typhoon, index) => {
                    const name = typhoon.cwaTyphoonName || typhoon.typhoonName || 'æœªçŸ¥ç†±å¸¶æ°£æ—‹';
                    const tyNo = typhoon.cwaTyNo || typhoon.cwaTdNo || '';
                    
                    // é¢±é¢¨å¼·åº¦è©•ç´š
                    let intensityClass = 'typhoon-weak';
                    let intensityText = 'è¼•åº¦';
                    const analysisData = typhoon.analysisData || {};
                    const fixes = analysisData.fix || [];
                    
                    if (fixes.length > 0) {
                        const latestFix = fixes[fixes.length - 1];
                        const windSpeed = parseInt(latestFix.maxWindSpeed || 0) * 3.6; // è½‰æ›ç‚º km/h
                        
                        if (windSpeed >= 118) {
                            intensityClass = 'typhoon-super';
                            intensityText = 'å¼·çƒˆé¢±é¢¨';
                        } else if (windSpeed >= 88) {
                            intensityClass = 'typhoon-strong';
                            intensityText = 'ä¸­åº¦é¢±é¢¨';
                        } else if (windSpeed >= 62) {
                            intensityClass = 'typhoon-moderate';
                            intensityText = 'è¼•åº¦é¢±é¢¨';
                        } else if (windSpeed >= 34) {
                            intensityClass = 'typhoon-weak';
                            intensityText = 'ç†±å¸¶é¢¨æš´';
                        } else {
                            intensityClass = 'typhoon-depression';
                            intensityText = 'ç†±å¸¶æ€§ä½æ°£å£“';
                        }
                    }
                    
                    html += `<div class="typhoon-card ${intensityClass}">`;
                    html += `<div class="typhoon-header">`;
                    html += `<h3 class="typhoon-name">ï¿½ ${name}</h3>`;
                    html += `<span class="typhoon-intensity">${intensityText}</span>`;
                    html += `</div>`;
                    
                    html += `<div class="data-grid">`;
                    
                    if (tyNo) {
                        html += `<div class="data-item"><div class="data-item-label">ğŸ·ï¸ ç·¨è™Ÿ</div><div class="data-item-value">${tyNo}</div></div>`;
                    }
                    
                    if (fixes.length > 0) {
                        const latestFix = fixes[fixes.length - 1];
                        
                        if (latestFix.maxWindSpeed) {
                            const windKmh = (parseInt(latestFix.maxWindSpeed) * 3.6).toFixed(1);
                            const windIcon = getWindIcon(windKmh);
                            html += `<div class="data-item wind-speed"><div class="data-item-label">${windIcon} æœ€å¤§é¢¨é€Ÿ</div><div class="data-item-value">${latestFix.maxWindSpeed} m/s<br><small>(${windKmh} km/h)</small></div></div>`;
                        }
                        
                        if (latestFix.maxGustSpeed) {
                            const gustKmh = (parseInt(latestFix.maxGustSpeed) * 3.6).toFixed(1);
                            html += `<div class="data-item"><div class="data-item-label">ğŸ’¨ æœ€å¤§é™£é¢¨</div><div class="data-item-value">${latestFix.maxGustSpeed} m/s<br><small>(${gustKmh} km/h)</small></div></div>`;
                        }
                        
                        if (latestFix.pressure) {
                            const pressureIcon = getPressureIcon(latestFix.pressure);
                            html += `<div class="data-item"><div class="data-item-label">${pressureIcon} ä¸­å¿ƒæ°£å£“</div><div class="data-item-value">${latestFix.pressure} hPa</div></div>`;
                        }
                        
                        if (latestFix.movingSpeed) {
                            html += `<div class="data-item"><div class="data-item-label">ğŸƒ ç§»å‹•é€Ÿåº¦</div><div class="data-item-value">${latestFix.movingSpeed} km/h</div></div>`;
                        }
                        
                        if (latestFix.movingDirection) {
                            const directionMap = {
                                'N': 'åŒ— â¬†ï¸', 'NNE': 'åŒ—åŒ—æ± â†—ï¸', 'NE': 'æ±åŒ— â†—ï¸', 'ENE': 'æ±åŒ—æ± â†—ï¸',
                                'E': 'æ± â¡ï¸', 'ESE': 'æ±å—æ± â†˜ï¸', 'SE': 'æ±å— â†˜ï¸', 'SSE': 'å—å—æ± â†˜ï¸',
                                'S': 'å— â¬‡ï¸', 'SSW': 'å—å—è¥¿ â†™ï¸', 'SW': 'è¥¿å— â†™ï¸', 'WSW': 'è¥¿å—è¥¿ â†™ï¸',
                                'W': 'è¥¿ â¬…ï¸', 'WNW': 'è¥¿åŒ—è¥¿ â†–ï¸', 'NW': 'è¥¿åŒ— â†–ï¸', 'NNW': 'åŒ—åŒ—è¥¿ â†–ï¸'
                            };
                            const directionZh = directionMap[latestFix.movingDirection] || latestFix.movingDirection;
                            html += `<div class="data-item"><div class="data-item-label">ğŸ§­ ç§»å‹•æ–¹å‘</div><div class="data-item-value">${directionZh}</div></div>`;
                        }
                        
                        if (latestFix.coordinate) {
                            try {
                                const [lon, lat] = latestFix.coordinate.split(',');
                                const distance = calculateDistanceToTaiwan(parseFloat(lat), parseFloat(lon));
                                html += `<div class="data-item"><div class="data-item-label">ğŸ“ åº§æ¨™ä½ç½®</div><div class="data-item-value">${lat}Â°N, ${lon}Â°E<br><small>è·å°ç£ç´„ ${distance} km</small></div></div>`;
                            } catch (e) {
                                html += `<div class="data-item"><div class="data-item-label">ğŸ“ åº§æ¨™ä½ç½®</div><div class="data-item-value">${latestFix.coordinate}</div></div>`;
                            }
                        }
                        
                        if (latestFix.circleOf15Ms && latestFix.circleOf15Ms.radius) {
                            html += `<div class="data-item storm-circle"><div class="data-item-label">ğŸŒªï¸ æš´é¢¨åœˆ</div><div class="data-item-value">${latestFix.circleOf15Ms.radius} km åŠå¾‘</div></div>`;
                        }
                        
                        if (latestFix.fixTime) {
                            const timeAgo = getTimeAgo(latestFix.fixTime);
                            html += `<div class="data-item"><div class="data-item-label">ğŸ• è§€æ¸¬æ™‚é–“</div><div class="data-item-value">${latestFix.fixTime.substring(0, 16)}<br><small>${timeAgo}</small></div></div>`;
                        }
                    }
                    
                    html += `</div></div>`;
                    if (index < typhoons.length - 1) html += '<hr class="typhoon-separator">';
                });
            } else {
                html += '<div class="no-data">ï¿½ ç›®å‰ç„¡æ´»èºé¢±é¢¨</div>';
            }
        } catch (error) {
            console.error('è§£æé¢±é¢¨è³‡æ–™å¤±æ•—:', error);
            html += '<div class="error-data">âŒ è§£æé¢±é¢¨è³‡æ–™å¤±æ•—</div>';
        }
        
        return html;
    }

    function formatWeatherData(data) {
        let html = '';
        try {
            const records = data.records || {};
            const locations = records.location || [];
            
            if (locations.length === 0) {
                return '<div class="no-data">ğŸ“­ ç„¡å¤©æ°£é å ±è³‡æ–™</div>';
            }
            
            html += `<div class="data-summary">ğŸŒ¤ï¸ ç›£æ§ ${locations.length} å€‹åœ°å€çš„å¤©æ°£é å ±</div>`;
            
            locations.forEach((location, index) => {
                const locationName = location.locationName || 'æœªçŸ¥åœ°å€';
                const elements = location.weatherElement || [];
                
                html += `<div class="weather-card">`;
                html += `<h4 class="location-title">ğŸ“ ${locationName}</h4>`;
                html += `<div class="data-grid">`;
                
                // æ•´ç†è³‡æ–™çµæ§‹ï¼Œæ–¹ä¾¿é¡¯ç¤º
                const weatherInfo = {};
                elements.forEach(element => {
                    const elementName = element.elementName || '';
                    const times = element.time || [];
                    
                    if (times.length > 0) {
                        const latestTime = times[0];
                        const value = latestTime.parameter?.parameterName || '';
                        const startTime = latestTime.startTime || '';
                        
                        weatherInfo[elementName] = { value, startTime };
                    }
                });
                
                // æŒ‰å„ªå…ˆé †åºé¡¯ç¤ºå¤©æ°£è³‡è¨Š
                if (weatherInfo.Wx && weatherInfo.Wx.value) {
                    const weatherIcon = getWeatherIcon(weatherInfo.Wx.value);
                    html += `<div class="data-item weather-phenomenon"><div class="data-item-label">${weatherIcon} å¤©æ°£ç¾è±¡</div><div class="data-item-value">${weatherInfo.Wx.value}<br><small>${weatherInfo.Wx.startTime.substring(0, 16)}</small></div></div>`;
                }
                
                if (weatherInfo.PoP && weatherInfo.PoP.value) {
                    const rainIcon = getRainIcon(weatherInfo.PoP.value);
                    html += `<div class="data-item rain-probability"><div class="data-item-label">${rainIcon} é™é›¨æ©Ÿç‡</div><div class="data-item-value">${weatherInfo.PoP.value}%</div></div>`;
                }
                
                // æº«åº¦ç¯„åœ
                const minTemp = weatherInfo.MinT?.value;
                const maxTemp = weatherInfo.MaxT?.value;
                if (minTemp && maxTemp) {
                    const tempIcon = getTempIcon(maxTemp);
                    html += `<div class="data-item temperature-range"><div class="data-item-label">${tempIcon} æº«åº¦ç¯„åœ</div><div class="data-item-value">${minTemp}Â°C ~ ${maxTemp}Â°C</div></div>`;
                } else {
                    if (minTemp) {
                        html += `<div class="data-item"><div class="data-item-label">ğŸŒ¡ï¸ æœ€ä½æº«åº¦</div><div class="data-item-value">${minTemp}Â°C</div></div>`;
                    }
                    if (maxTemp) {
                        html += `<div class="data-item"><div class="data-item-label">ğŸŒ¡ï¸ æœ€é«˜æº«åº¦</div><div class="data-item-value">${maxTemp}Â°C</div></div>`;
                    }
                }
                
                if (weatherInfo.CI && weatherInfo.CI.value) {
                    const comfortIcon = getComfortIcon(weatherInfo.CI.value);
                    html += `<div class="data-item comfort-index"><div class="data-item-label">${comfortIcon} èˆ’é©åº¦</div><div class="data-item-value">${weatherInfo.CI.value}</div></div>`;
                }
                
                html += `</div></div>`;
                if (index < locations.length - 1) html += '<hr class="location-separator">';
            });
        } catch (error) {
            console.error('è§£æå¤©æ°£è³‡æ–™å¤±æ•—:', error);
            html += '<div class="error-data">âŒ è§£æå¤©æ°£è³‡æ–™å¤±æ•—</div>';
        }
        
        return html;
    }

    function formatAlertData(data) {
        let html = '';
        try {
            const records = data.records || {};
            const locations = records.location || [];
            
            if (locations.length === 0) {
                return '<div class="no-data">ğŸ“­ ç„¡ç‰¹å ±è³‡æ–™</div>';
            }
            
            let alertCount = 0;
            let tempHtml = '';
            
            locations.forEach((location, index) => {
                const locationName = location.locationName || 'æœªçŸ¥åœ°å€';
                const hazards = location.hazardConditions?.hazards || [];
                
                if (hazards.length > 0) {
                    alertCount += hazards.length;
                    tempHtml += `<div class="alert-card">`;
                    tempHtml += `<h4 class="location-title alert-location">âš ï¸ ${locationName}</h4>`;
                    tempHtml += `<div class="data-grid">`;
                    
                    hazards.forEach(hazard => {
                        const phenomena = hazard.phenomena || '';
                        const significance = hazard.significance || '';
                        const effectiveTime = hazard.effectiveTime || '';
                        
                        if (phenomena) {
                            const alertIcon = getAlertIcon(phenomena);
                            const alertClass = getAlertClass(phenomena, significance);
                            
                            tempHtml += `<div class="data-item alert-item ${alertClass}">`;
                            tempHtml += `<div class="data-item-label">${alertIcon} ç‰¹å ±é¡å‹</div>`;
                            tempHtml += `<div class="data-item-value">${phenomena} ${significance}`;
                            
                            if (effectiveTime) {
                                const timeAgo = getTimeAgo(effectiveTime);
                                tempHtml += `<br><small>ç”Ÿæ•ˆ: ${effectiveTime.substring(0, 16)}<br>${timeAgo}</small>`;
                            }
                            
                            tempHtml += `</div></div>`;
                        }
                    });
                    
                    tempHtml += `</div></div>`;
                    if (index < locations.length - 1) tempHtml += '<hr class="alert-separator">';
                }
            });
            
            if (alertCount > 0) {
                html += `<div class="data-summary alert-summary">âš ï¸ ç™¼ç¾ ${alertCount} é …ç‰¹å ±è­¦è¨Š</div>`;
                html += tempHtml;
            } else {
                html += '<div class="no-data">âœ… ç›®å‰ç„¡ç‰¹å ±è³‡æ–™</div>';
            }
            
        } catch (error) {
            console.error('è§£æç‰¹å ±è³‡æ–™å¤±æ•—:', error);
            html += '<div class="error-data">âŒ è§£æç‰¹å ±è³‡æ–™å¤±æ•—</div>';
        }
        
        return html;
    }

    async function updateData() {
        try {
            const response = await fetch('/api/status');
            const data = await response.json();
            document.getElementById('updateTime').textContent = new Date(data.timestamp).toLocaleString('zh-TW');
            
            // æ›´æ–°èˆªç­é¢¨éšªä¿¡æ¯
            const flightRiskLevel = document.getElementById('flightRiskLevel');
            const flightRiskReason = document.getElementById('flightRiskReason');
            if (flightRiskLevel && flightRiskReason) {
                flightRiskLevel.innerHTML = `<span class="risk-${getRiskClass(data.travel_risk)}">${data.travel_risk}</span>`;
                flightRiskReason.textContent = getFlightRiskReason(data);
            }
            
            // æ›´æ–°é«”æª¢é¢¨éšªä¿¡æ¯
            const checkupRiskLevel = document.getElementById('checkupRiskLevel');
            const checkupRiskReason = document.getElementById('checkupRiskReason');
            if (checkupRiskLevel && checkupRiskReason) {
                checkupRiskLevel.innerHTML = `<span class="risk-${getRiskClass(data.checkup_risk)}">${data.checkup_risk}</span>`;
                checkupRiskReason.textContent = getCheckupRiskReason(data);
            }
            
            // æ›´æ–°ç•¶å‰è­¦å ±
            const currentAlertsDiv = document.getElementById('currentAlerts');
            if (data.warnings.length > 0) {
                let alertsHtml = '';
                data.warnings.forEach(warning => {
                    alertsHtml += `<div class="alert-item">${warning}</div>`;
                });
                currentAlertsDiv.innerHTML = alertsHtml;
            } else {
                currentAlertsDiv.innerHTML = '<div class="no-alerts">âœ… ç›®å‰ç„¡ç‰¹æ®Šè­¦å ±</div>';
            }

            await updateRawData();
            
        } catch (error) {
            console.error('æ›´æ–°è³‡æ–™å¤±æ•—:', error);
        }
    }

    function getFlightRiskReason(data) {
        if (data.travel_risk.includes('é«˜é¢¨éšª')) {
            return 'é¢±é¢¨é¢¨é€Ÿéé«˜æˆ–æš´é¢¨åœˆå½±éŸ¿é‡‘é–€æ©Ÿå ´ï¼Œå¯èƒ½å°è‡´èˆªç­å–æ¶ˆæˆ–å»¶èª¤';
        } else if (data.travel_risk.includes('ä¸­é¢¨éšª')) {
            return 'æœ‰å¼·é¢¨ç‰¹å ±æˆ–ä¸­åº¦é¢±é¢¨å½±éŸ¿ï¼Œå»ºè­°å¯†åˆ‡é—œæ³¨èˆªç­å‹•æ…‹';
        } else {
            return 'å¤©æ°£æ¢ä»¶è‰¯å¥½ï¼Œé æœŸæ­£å¸¸èµ·é™';
        }
    }

    function getCheckupRiskReason(data) {
        if (data.checkup_risk.includes('é«˜é¢¨éšª')) {
            return 'é¢±é¢¨ç›´æ¥å½±éŸ¿å°å—åœ°å€ï¼Œå»ºè­°å»¶å¾Œé«”æª¢è¡Œç¨‹ç¢ºä¿å®‰å…¨';
        } else if (data.checkup_risk.includes('ä¸­é¢¨éšª')) {
            return 'æœ‰è±ªé›¨æˆ–å¼·é¢¨è­¦å ±ï¼Œå¤–å‡ºéœ€æ³¨æ„äº¤é€šå®‰å…¨';
        } else {
            return 'å¤©æ°£ç‹€æ³ç©©å®šï¼Œé©åˆé€²è¡Œé«”æª¢è¡Œç¨‹';
        }
    }

    async function updateRawData() {
        try {
            const startTime = Date.now();
            const rawDataResponse = await fetch('/api/raw-data');
            const loadTime = Date.now() - startTime;
            const rawData = await rawDataResponse.json();
            
            // æ›´æ–°ç‹€æ…‹é¡¯ç¤º
            updateDataStatus('typhoon', rawData.typhoons);
            updateDataStatus('weather', rawData.weather);
            updateDataStatus('alert', rawData.alerts);
            
            // æ›´æ–°è³‡æ–™å…§å®¹
            document.getElementById('typhoonData').innerHTML = formatRawData(rawData.typhoons, 'typhoon');
            document.getElementById('alertData').innerHTML = formatRawData(rawData.alerts, 'alert');
            
            // åˆ†åˆ¥æ›´æ–°å°å—å’Œé‡‘é–€çš„å¤©æ°£è³‡æ–™
            updateLocationWeatherData(rawData.weather, 'tainanWeatherData', 'å°å—å¸‚');
            updateLocationWeatherData(rawData.weather, 'kinmenWeatherData', 'é‡‘é–€ç¸£');
            
            // æ›´æ–° API çµ±è¨ˆ
            document.getElementById('apiStatsData').innerHTML = formatApiStats(rawData, loadTime);
            
        } catch (error) {
            console.error('æ›´æ–°åŸå§‹è³‡æ–™å¤±æ•—:', error);
            document.getElementById('typhoonData').innerHTML = '<div class="error-data">âŒ è³‡æ–™è¼‰å…¥å¤±æ•—</div>';
            document.getElementById('alertData').innerHTML = '<div class="error-data">âŒ è³‡æ–™è¼‰å…¥å¤±æ•—</div>';
            if (document.getElementById('tainanWeatherData')) {
                document.getElementById('tainanWeatherData').innerHTML = '<div class="error-data">âŒ è³‡æ–™è¼‰å…¥å¤±æ•—</div>';
            }
            if (document.getElementById('kinmenWeatherData')) {
                document.getElementById('kinmenWeatherData').innerHTML = '<div class="error-data">âŒ è³‡æ–™è¼‰å…¥å¤±æ•—</div>';
            }
        }
    }

    function updateLocationWeatherData(weatherData, elementId, locationName) {
        const element = document.getElementById(elementId);
        if (!element) return;
        
        try {
            const records = weatherData.records || {};
            const locations = records.location || [];
            const targetLocation = locations.find(loc => loc.locationName && loc.locationName.includes(locationName));
            
            if (targetLocation) {
                element.innerHTML = formatLocationWeather(targetLocation);
            } else {
                element.innerHTML = `<div class="no-data">ğŸ“­ ç„¡ ${locationName} å¤©æ°£è³‡æ–™</div>`;
            }
        } catch (error) {
            console.error(`æ›´æ–° ${locationName} å¤©æ°£è³‡æ–™å¤±æ•—:`, error);
            element.innerHTML = '<div class="error-data">âŒ è³‡æ–™è¼‰å…¥å¤±æ•—</div>';
        }
    }

    function formatLocationWeather(location) {
        const locationName = location.locationName || 'æœªçŸ¥åœ°å€';
        const elements = location.weatherElement || [];
        
        let html = `<div class="location-weather-card">`;
        html += `<div class="data-grid">`;
        
        // æ•´ç†è³‡æ–™çµæ§‹ï¼Œæ–¹ä¾¿é¡¯ç¤º
        const weatherInfo = {};
        elements.forEach(element => {
            const elementName = element.elementName || '';
            const times = element.time || [];
            
            if (times.length > 0) {
                const latestTime = times[0];
                const value = latestTime.parameter?.parameterName || '';
                const startTime = latestTime.startTime || '';
                
                weatherInfo[elementName] = { value, startTime };
            }
        });
        
        // æŒ‰å„ªå…ˆé †åºé¡¯ç¤ºå¤©æ°£è³‡è¨Š
        if (weatherInfo.Wx && weatherInfo.Wx.value) {
            const weatherIcon = getWeatherIcon(weatherInfo.Wx.value);
            html += `<div class="data-item weather-phenomenon"><div class="data-item-label">${weatherIcon} å¤©æ°£ç¾è±¡</div><div class="data-item-value">${weatherInfo.Wx.value}<br><small>${weatherInfo.Wx.startTime.substring(0, 16)}</small></div></div>`;
        }
        
        if (weatherInfo.PoP && weatherInfo.PoP.value) {
            const rainIcon = getRainIcon(weatherInfo.PoP.value);
            html += `<div class="data-item rain-probability"><div class="data-item-label">${rainIcon} é™é›¨æ©Ÿç‡</div><div class="data-item-value">${weatherInfo.PoP.value}%</div></div>`;
        }
        
        // æº«åº¦ç¯„åœ
        const minTemp = weatherInfo.MinT?.value;
        const maxTemp = weatherInfo.MaxT?.value;
        if (minTemp && maxTemp) {
            const tempIcon = getTempIcon(maxTemp);
            html += `<div class="data-item temperature-range"><div class="data-item-label">${tempIcon} æº«åº¦ç¯„åœ</div><div class="data-item-value">${minTemp}Â°C ~ ${maxTemp}Â°C</div></div>`;
        } else {
            if (minTemp) {
                html += `<div class="data-item"><div class="data-item-label">ğŸŒ¡ï¸ æœ€ä½æº«åº¦</div><div class="data-item-value">${minTemp}Â°C</div></div>`;
            }
            if (maxTemp) {
                html += `<div class="data-item"><div class="data-item-label">ğŸŒ¡ï¸ æœ€é«˜æº«åº¦</div><div class="data-item-value">${maxTemp}Â°C</div></div>`;
            }
        }
        
        if (weatherInfo.CI && weatherInfo.CI.value) {
            const comfortIcon = getComfortIcon(weatherInfo.CI.value);
            html += `<div class="data-item comfort-index"><div class="data-item-label">${comfortIcon} èˆ’é©åº¦</div><div class="data-item-value">${weatherInfo.CI.value}</div></div>`;
        }
        
        html += `</div></div>`;
        return html;
    }

    function updateDataStatus(type, data) {
        const statusElement = document.getElementById(`${type}-status`);
        if (!data || Object.keys(data).length === 0) {
            statusElement.innerHTML = '<span class="status-no-data">ç„¡è³‡æ–™</span>';
            return;
        }

        let count = 0;
        if (type === 'typhoon') {
            const typhoons = data.records?.tropicalCyclones?.tropicalCyclone || [];
            count = typhoons.length;
            statusElement.innerHTML = count > 0 ? 
                `<span class="status-active">${count} å€‹é¢±é¢¨</span>` : 
                '<span class="status-safe">ç„¡é¢±é¢¨</span>';
        } else if (type === 'weather') {
            const locations = data.records?.location || [];
            count = locations.length;
            statusElement.innerHTML = count > 0 ? 
                `<span class="status-normal">${count} åœ°å€</span>` : 
                '<span class="status-no-data">ç„¡è³‡æ–™</span>';
        } else if (type === 'alert') {
            const locations = data.records?.location || [];
            count = locations.reduce((total, loc) => total + (loc.hazardConditions?.hazards?.length || 0), 0);
            statusElement.innerHTML = count > 0 ? 
                `<span class="status-warning">${count} é …è­¦å ±</span>` : 
                '<span class="status-safe">ç„¡è­¦å ±</span>';
        }
    }

    function formatApiStats(rawData, loadTime) {
        let html = '<div class="data-grid">';
        
        // API å›æ‡‰æ™‚é–“
        html += `<div class="data-item"><div class="data-item-label">âš¡ API å›æ‡‰æ™‚é–“</div><div class="data-item-value">${loadTime} ms</div></div>`;
        
        // è³‡æ–™å¤§å°çµ±è¨ˆ
        const dataSize = JSON.stringify(rawData).length;
        const dataSizeKB = (dataSize / 1024).toFixed(2);
        html += `<div class="data-item"><div class="data-item-label">ğŸ“Š è³‡æ–™å¤§å°</div><div class="data-item-value">${dataSizeKB} KB</div></div>`;
        
        // é¢±é¢¨çµ±è¨ˆ
        const typhoonCount = rawData.typhoons?.records?.tropicalCyclones?.tropicalCyclone?.length || 0;
        html += `<div class="data-item"><div class="data-item-label">ğŸŒ€ æ´»èºé¢±é¢¨</div><div class="data-item-value">${typhoonCount} å€‹</div></div>`;
        
        // ç›£æ§åœ°å€çµ±è¨ˆ
        const weatherLocations = rawData.weather?.records?.location?.length || 0;
        html += `<div class="data-item"><div class="data-item-label">ğŸ“ ç›£æ§åœ°å€</div><div class="data-item-value">${weatherLocations} å€‹</div></div>`;
        
        // ç‰¹å ±çµ±è¨ˆ
        const alertLocations = rawData.alerts?.records?.location || [];
        const totalAlerts = alertLocations.reduce((total, loc) => total + (loc.hazardConditions?.hazards?.length || 0), 0);
        html += `<div class="data-item"><div class="data-item-label">âš ï¸ ç‰¹å ±æ•¸é‡</div><div class="data-item-value">${totalAlerts} é …</div></div>`;
        
        // æœ€å¾Œæ›´æ–°æ™‚é–“
        const updateTime = new Date().toLocaleString('zh-TW');
        html += `<div class="data-item"><div class="data-item-label">ğŸ• æ›´æ–°æ™‚é–“</div><div class="data-item-value">${updateTime}</div></div>`;
        
        html += '</div>';
        return html;
    }

    // Helper functions for icons and calculations
    function getWindIcon(windSpeed) {
        if (windSpeed >= 118) return 'ğŸŒªï¸';
        if (windSpeed >= 88) return 'ğŸ’¨';
        if (windSpeed >= 62) return 'ğŸŒ¬ï¸';
        if (windSpeed >= 34) return 'ğŸƒ';
        return 'ğŸŒ¬ï¸';
    }

    function getPressureIcon(pressure) {
        if (pressure < 950) return 'ğŸ”´';
        if (pressure < 980) return 'ğŸŸ ';
        return 'ğŸ“Š';
    }

    function getWeatherIcon(weather) {
        if (weather.includes('æ™´')) return 'â˜€ï¸';
        if (weather.includes('é›²')) return 'â˜ï¸';
        if (weather.includes('é™°')) return 'â˜ï¸';
        if (weather.includes('é›¨')) return 'ğŸŒ§ï¸';
        if (weather.includes('é›·')) return 'â›ˆï¸';
        if (weather.includes('éœ§')) return 'ğŸŒ«ï¸';
        return 'ğŸŒ¤ï¸';
    }

    function getRainIcon(probability) {
        if (probability >= 80) return 'ğŸŒ§ï¸';
        if (probability >= 60) return 'ğŸŒ¦ï¸';
        if (probability >= 30) return 'â›…';
        return 'â˜€ï¸';
    }

    function getTempIcon(temp) {
        if (temp >= 35) return 'ğŸ¥µ';
        if (temp >= 25) return 'ğŸŒ¡ï¸';
        if (temp >= 15) return 'ğŸŒ¡ï¸';
        return 'ğŸ¥¶';
    }

    function getComfortIcon(comfort) {
        if (comfort.includes('èˆ’é©')) return 'ğŸ˜Š';
        if (comfort.includes('æ‚¶ç†±')) return 'ğŸ˜°';
        if (comfort.includes('å¯’å†·')) return 'ğŸ¥¶';
        return 'ğŸ˜Œ';
    }

    function getAlertIcon(phenomena) {
        if (phenomena.includes('é¢±é¢¨')) return 'ğŸŒªï¸';
        if (phenomena.includes('å¼·é¢¨')) return 'ğŸ’¨';
        if (phenomena.includes('è±ªé›¨')) return 'ğŸŒ§ï¸';
        if (phenomena.includes('é›·é›»')) return 'â›ˆï¸';
        return 'âš ï¸';
    }

    function getAlertClass(phenomena, significance) {
        if (phenomena.includes('é¢±é¢¨') || significance.includes('è­¦å ±')) return 'alert-danger';
        if (phenomena.includes('è±ªé›¨') || significance.includes('ç‰¹å ±')) return 'alert-warning';
        return 'alert-info';
    }

    function calculateDistanceToTaiwan(lat, lon) {
        // å°ç£ä¸­å¿ƒé»åº§æ¨™ (å¤§ç´„)
        const taiwanLat = 23.8;
        const taiwanLon = 121.0;
        
        const R = 6371; // åœ°çƒåŠå¾‘ km
        const dLat = (lat - taiwanLat) * Math.PI / 180;
        const dLon = (lon - taiwanLon) * Math.PI / 180;
        const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                  Math.cos(taiwanLat * Math.PI / 180) * Math.cos(lat * Math.PI / 180) *
                  Math.sin(dLon/2) * Math.sin(dLon/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        const distance = R * c;
        
        return Math.round(distance);
    }

    function getTimeAgo(timeString) {
        const now = new Date();
        const time = new Date(timeString);
        const diffMs = now - time;
        const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
        const diffMins = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));
        
        if (diffHours > 0) {
            return `${diffHours} å°æ™‚ ${diffMins} åˆ†é˜å‰`;
        } else {
            return `${diffMins} åˆ†é˜å‰`;
        }
    }
    function getRiskClass(risk) {
        if (risk.includes('é«˜é¢¨éšª')) return 'high';
        if (risk.includes('ä¸­é¢¨éšª')) return 'medium';
        return 'low';
    }

    // Typhoon Map Functions
    function toggleMap() {
        const mapContainer = document.getElementById('mapContainer');
        const toggleBtn = document.getElementById('mapToggleBtn');
        
        if (mapContainer.style.display === 'none') {
            mapContainer.style.display = 'block';
            toggleBtn.textContent = 'ğŸ—ºï¸ éš±è—åœ°åœ–';
            toggleBtn.classList.add('active');
            
            // å»¶é²è¼‰å…¥ iframe ä»¥æå‡æ€§èƒ½
            const iframe = document.getElementById('typhoonMap');
            if (!iframe.src || iframe.src === 'about:blank') {
                iframe.src = 'https://app.cwa.gov.tw/web/obsmap/typhoon.html';
            }
        } else {
            mapContainer.style.display = 'none';
            toggleBtn.textContent = 'ğŸ—ºï¸ é¡¯ç¤ºåœ°åœ–';
            toggleBtn.classList.remove('active');
        }
    }

    function refreshMap() {
        const iframe = document.getElementById('typhoonMap');
        const refreshBtn = document.querySelector('.map-refresh-btn');
        
        refreshBtn.textContent = 'â³ æ›´æ–°ä¸­...';
        refreshBtn.disabled = true;
        
        // å¼·åˆ¶é‡æ–°è¼‰å…¥ iframe
        const currentSrc = iframe.src;
        iframe.src = 'about:blank';
        
        setTimeout(() => {
            iframe.src = currentSrc + '?t=' + new Date().getTime(); // åŠ å…¥æ™‚é–“æˆ³é¿å…å¿«å–
            
            iframe.onload = () => {
                refreshBtn.textContent = 'âœ… å·²æ›´æ–°';
                setTimeout(() => {
                    refreshBtn.textContent = 'ğŸ”„ åˆ·æ–°åœ°åœ–';
                    refreshBtn.disabled = false;
                }, 2000);
            };
            
            // å¦‚æœè¼‰å…¥å¤±æ•—çš„å‚™ç”¨æ–¹æ¡ˆ
            setTimeout(() => {
                if (refreshBtn.disabled) {
                    refreshBtn.textContent = 'ğŸ”„ åˆ·æ–°åœ°åœ–';
                    refreshBtn.disabled = false;
                }
            }, 10000);
        }, 500);
    }

    // æ¯30ç§’æ›´æ–°ä¸€æ¬¡
    updateData();
    setInterval(updateData, 30000);
</script>
{% endblock %}